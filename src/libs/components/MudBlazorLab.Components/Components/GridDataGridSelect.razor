@typeparam TItem where TItem : class
@using MudBlazor

<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
    <MudTextField @bind-Value="selectedText" Label="@Label" Variant="@Variant" ReadOnly="true" FullWidth="@FullWidth" />
    <!-- 根据 _open 状态切换图标 -->
    <MudIconButton Icon="@(_open ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Filled.ArrowDropDown)" 
                   Color="Color.Default" 
                   OnClick="@(() => _open = !_open)" />
    
    <MudPopover Open="@_open" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <MudPaper Style="@($"max-height: {GridMaxHeight}px; overflow-y: auto; width: 100%;")">
            <MudDataGrid T="TItem" Items="@Items" MultiSelection="true" SelectedItems="@selectedItems"
                SelectedItemsChanged="@OnSelectedItemsChangedInternal" SelectOnRowClick="true" Hover="true"
                Dense="@Dense" Height="@GridHeight" Filterable="@Filterable" FilterMode="@FilterMode"
                SortMode="@SortMode">
                <Columns>
                    <SelectColumn T="TItem" />
                    @ColumnsTemplate
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="TItem" />
                </PagerContent>
            </MudDataGrid>
        </MudPaper>
    </MudPopover>
</MudStack>


@code {
    private HashSet<TItem> selectedItems = new HashSet<TItem>();
    private string selectedText = string.Empty;
    private bool _open;

    /// <summary>
    /// 数据源
    /// </summary>
    [Parameter]
    public IEnumerable<TItem> Items { get; set; } = new List<TItem>();

    /// <summary>
    /// 列定义模板
    /// </summary>
    [Parameter]
    public RenderFragment ColumnsTemplate { get; set; }

    /// <summary>
    /// 选中项变化回调
    /// </summary>
    [Parameter]
    public EventCallback<HashSet<TItem>> SelectedItemsChanged { get; set; }

    /// <summary>
    /// 获取显示文本的函数
    /// </summary>
    [Parameter]
    public Func<TItem, string> DisplayTextSelector { get; set; }

    /// <summary>
    /// 文本框标签
    /// </summary>
    [Parameter]
    public string Label { get; set; } = "请选择";

    /// <summary>
    /// 是否全宽
    /// </summary>
    [Parameter]
    public bool FullWidth { get; set; } = true;

    /// <summary>
    /// 菜单最大高度
    /// </summary>
    [Parameter]
    public int MaxHeight { get; set; } = 600;

    /// <summary>
    /// 表格最大高度
    /// </summary>
    [Parameter]
    public int GridMaxHeight { get; set; } = 500;

    /// <summary>
    /// 表格高度
    /// </summary>
    [Parameter]
    public string GridHeight { get; set; } = "400";

    /// <summary>
    /// 是否紧凑模式
    /// </summary>
    [Parameter]
    public bool Dense { get; set; } = true;

    /// <summary>
    /// 是否可筛选
    /// </summary>
    [Parameter]
    public bool Filterable { get; set; } = true;

    /// <summary>
    /// 筛选模式
    /// </summary>
    [Parameter]
    public DataGridFilterMode FilterMode { get; set; } = DataGridFilterMode.ColumnFilterRow;

    /// <summary>
    /// 排序模式
    /// </summary>
    [Parameter]
    public SortMode SortMode { get; set; } = SortMode.Multiple;

    /// <summary>
    /// 是否显示分页器
    /// </summary>
    [Parameter]
    public bool ShowPager { get; set; } = true;

    /// <summary>
    /// 文本框变体样式
    /// </summary>
    [Parameter]
    public Variant Variant { get; set; } = Variant.Text;

    /// <summary>
    /// 选中项分隔符
    /// </summary>
    [Parameter]
    public string Separator { get; set; } = ", ";

    /// <summary>
    /// 双向绑定的选中项集合
    /// </summary>
    [Parameter]
    public HashSet<TItem> SelectedItems
    {
        get => selectedItems;
        set
        {
            if (selectedItems != value)
            {
                selectedItems = value ?? new HashSet<TItem>();
                UpdateSelectedText();
            }
        }
    }

    private async Task OnSelectedItemsChangedInternal(HashSet<TItem> items)
    {
        selectedItems = items ?? new HashSet<TItem>();
        UpdateSelectedText();
        await SelectedItemsChanged.InvokeAsync(selectedItems);
    }

    private void UpdateSelectedText()
    {
        if (DisplayTextSelector == null)
        {
            selectedText = selectedItems.Any()
            ? $"已选择 {selectedItems.Count} 项"
            : string.Empty;
        }
        else
        {
            selectedText = selectedItems.Any()
            ? string.Join(Separator, selectedItems.Select(DisplayTextSelector))
            : string.Empty;
        }
    }

    protected override void OnParametersSet()
    {
        UpdateSelectedText();
    }
}
