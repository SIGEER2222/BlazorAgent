@using Bogus
@using MudBlazor
@using MudBlazorLab.Components.Models

<MudStack Spacing="2">
  <MudSelect T="InspectionTemplate" Label="表单模板" Value="_template" ValueChanged="OnTemplateChanged"
    ToStringFunc="@(t => t?.Name ?? string.Empty)">
    @foreach (var t in Templates)
    {
      <MudSelectItem Value="@t">@t.Name</MudSelectItem>
    }
  </MudSelect>
  <MudTextField T="string" Label="表单单号" @bind-Value="_docNo" />
  <MudTextField T="string" Label="ERP单号" @bind-Value="_erpNo" />
  <MudDatePicker Label="创建日期" @bind-Date="_createdAt" />
  <MudTextField T="string" Label="创建人" @bind-Value="_creator" />
  <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
    <MudButton Variant="Variant.Text" OnClick="Cancel">取消</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Ok">确定</MudButton>
  </MudStack>
</MudStack>

@code {
  [Parameter] public List<InspectionTemplate> Templates { get; set; } = new();
  [Parameter] public EventCallback OnCancel { get; set; }
  [Parameter] public EventCallback<DocHeader> OnSubmit { get; set; }

  InspectionTemplate? _template;
  string _docNo = string.Empty;
  string _erpNo = string.Empty;
  string _status = "创建";
  DateTime? _createdAt;
  string _creator = string.Empty;

  protected override void OnInitialized()
  {
    var faker = new Faker("zh_CN");
    _template = Templates.FirstOrDefault();
    _docNo = $"M{DateTime.Now:yyyyMMdd}-{faker.Random.Int(1, 9999):0000}";
    _erpNo = faker.Random.Replace("RCV##########");
    _createdAt = DateTime.Now;
    _creator = faker.Name.FullName();
  }

  Task OnTemplateChanged(InspectionTemplate? t)
  {
    _template = t; return Task.CompletedTask;
  }

  async Task Cancel() { await OnCancel.InvokeAsync(); }
  async Task Ok()
  {
    var doc = new DocHeader
    {
      Template = _template?.Name ?? string.Empty,
      DocNo = _docNo,
      ErpNo = _erpNo,
      StatusText = _status,
      CreatedAt = _createdAt ?? DateTime.Now,
      Creator = _creator
    };
    await OnSubmit.InvokeAsync(doc);
  }
}