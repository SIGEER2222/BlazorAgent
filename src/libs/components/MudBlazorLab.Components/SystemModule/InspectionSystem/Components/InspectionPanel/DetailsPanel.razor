@using System.Threading.Tasks
@using System.Linq
@using InspectionSystem.Models
@using InspectionSystem.Services
@using HmiInspection.Models
@using MudBlazor
@namespace MudBlazorLab.Components.Components.InspectionPanel

<MudOverlay @bind-Visible="@Visible" DarkBackground="true" Class="d-flex align-center justify-center">

    <MudPaper Elevation="24" Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">详情：@(CurrentObject?.ObjectName)</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                Disabled="@(CurrentDoc==null || CurrentDoc.Status!="开始" || CurrentObject==null)"
                StartIcon="@Icons.Material.Filled.AddTask" OnClick="NewDetail">新增详情项</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Close">关闭</MudButton>
        </MudStack>
        <MudDataGrid @ref="InspectionDetailGrid" T="InspectionFlatRow" Items="@_flatRows"
            Bordered="true" Dense="true" Hover="true" Filterable="true" FixedHeader="true" Height="60vh"
            RowsPerPage="@_detailPageSize" SortMode="SortMode.Multiple">
            <Columns>
                <PropertyColumn T="InspectionFlatRow" TProperty="int" Property="@(x => x.BatchIndex)" Title="序号" />
                <PropertyColumn T="InspectionFlatRow" TProperty="string" Property="@(x => x.SampleBatchNo)" Title="批次号" />
                <PropertyColumn T="InspectionFlatRow" TProperty="string" Property="@(x => x.BatchCheckResult)" Title="批次整体结果" />
                <PropertyColumn T="InspectionFlatRow" TProperty="string" Property="@(x => x.ItemName)" Title="检查项" />
                <PropertyColumn T="InspectionFlatRow" TProperty="string" Property="@(x => x.ItemDescription)" Title="检查描述" />
                <PropertyColumn T="InspectionFlatRow" TProperty="string" Property="@(x => x.Unit)" Title="单位" />
                <PropertyColumn T="InspectionFlatRow" TProperty="decimal?" Property="@(x => x.Value)" Title="数值" />
                <PropertyColumn T="InspectionFlatRow" TProperty="string" Property="@(x => x.CheckResult)" Title="单项结果" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="InspectionFlatRow" PageSizeOptions="@_detailPageOptions" />
            </PagerContent>
        </MudDataGrid>
    </MudPaper>
</MudOverlay>

<MudDialog @bind-Visible="_dlgDetail" Options="_dialogOptions">
    <DialogContent>
        <MudPaper Class="pa-2">
            <MudStack Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudText Typo="Typo.h6">新增详情项</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                        OnClick="AddDetailRow">新增一行</MudButton>
                </MudStack>

                <MudTextField @bind-Value="_sampleBatchNo" Label="@(_isRequiredSN ? "批次号(必填)" : "批次号(可空)")" Required="@_isRequiredSN" Placeholder="例如：BATCH-2025-001" />

                <MudTable Items="@_bulkDetails" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>检查项</MudTh>
                        <MudTh>描述</MudTh>
                        <MudTh>单位</MudTh>
                        <MudTh>数值</MudTh>
                        <MudTh>结果</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="row">
                        <MudTd>
                            <MudAutocomplete T="string" @bind-Value="@row.ItemName" SearchFunc="SearchCheckItems"
                                CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />
                        </MudTd>
                        <MudTd>
                            <MudAutocomplete T="string" @bind-Value="row.ItemDescription"
                                SearchFunc="SearchItemDescriptions" CoerceText="true" CoerceValue="true"
                                Clearable="true" Dense="true" />
                        </MudTd>
                        <MudTd>
                            <MudAutocomplete T="string" @bind-Value="row.Unit" SearchFunc="SearchUnits"
                                CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />
                        </MudTd>
                        <MudTd>
                            <MudTextField T="string" @bind-Value="row.ValueText" Dense="true" />
                        </MudTd>
                        <MudTd>
                            <MudSelect T="string" @bind-Value="row.CheckResult" Dense="true">
                                <MudSelectItem Value="InspectionResult.OK.ToString()">OK</MudSelectItem>
                                <MudSelectItem Value="InspectionResult.NG.ToString()">NG</MudSelectItem>
                            </MudSelect>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudStack>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(() => _dlgDetail = false)">取消</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!CanSaveDetail)" OnClick="SaveDetail">确定
        </MudButton>
    </DialogActions>
</MudDialog>
