@using global::InspectionSystem.Models
@using InspectionSystem.Services
@using InspectionSystem.Data
@using HmiInspection.Models
@namespace MudBlazorLab.Components.Components.InspectionPanel
@using MudBlazor
@inject IInspectionConfigService ConfigSvc
@inject InspectionSystem.Data.InspectionDb Db

<style>
    .mud-overlay {
        z-index: 6500 !important
    }

    .mud-dialog {
        z-index: 6600 !important
    }

    .mud-dialog-container {
        z-index: 6600 !important
    }
</style>

<MudOverlay @bind-Visible="@Visible" DarkBackground="true" Class="d-flex align-center justify-center"
    Style="position:fixed;inset:0;z-index:6400;">

    <MudPaper Elevation="24" Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">对象：@(Form?.FormNo)</MudText>
            <MudText Typo="Typo.subtitle2">工单：@(Form?.WorkCenter)</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(AllowAddDetail)"
                StartIcon="@Icons.Material.Filled.Add" OnClick="NewObject">新增对象</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Close">关闭</MudButton>
        </MudStack>
        <MudDataGrid @ref="InspectionObjectGrid" T="InspectionObjectView" Items="@_objectsView" Bordered="true"
            Dense="true" Hover="true" Filterable="true" FixedHeader="true" Height="65vh" RowsPerPage="@_objPageSize"
            RowClick="OnObjectRowClickView" SortMode="SortMode.Multiple">
            <Columns>
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.FormTemplateName)"
                    Title="表单模板" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.FormNo)" Title="表单单号" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.WorkCenter)" Title="工单单号" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.ProductName)"
                    Title="产线名称" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.ObjectType)"
                                Title="对象类型" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.ObjectDisplayName)"
                                Title="对象名称" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.CheckResult)"
                                Title="结果" />
                <PropertyColumn T="InspectionObjectView" TProperty="DateTime?" Property="@(x => x.CreatedAt)"
                    Title="创建日期" />
                <PropertyColumn T="InspectionObjectView" TProperty="string" Property="@(x => x.CreateUser)"
                    Title="创建人" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="InspectionObjectView" PageSizeOptions="@_objPageOptions" />
            </PagerContent>
        </MudDataGrid>
    </MudPaper>
</MudOverlay>

<MudDialog @bind-Visible="_dlgObject">
    <DialogContent>
        <MudStack Spacing="2">
            <MudAutocomplete T="string" @bind-Value="_objectType" Label="对象类型" Placeholder="对象类型"
                SearchFunc="SearchObjectTypes" CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />
            <MudTextField @bind-Value="_objectName" Label="对象名称" Placeholder="对象名称" Required="true" />
            <MudTextField @bind-Value="_objectCreator" Label="创建人" Placeholder="创建人" Required="true" />
            <MudDatePicker @bind-Date="_objectCreatedAt" Label="创建日期" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(() => _dlgObject = false)">取消</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveObject">确定</MudButton>
    </DialogActions>
</MudDialog>

<DetailsPanel Visible="_openDetailsPanel" CurrentDoc="Form" CurrentObject="_currentObject"
    OnClose="CloseDetailsPanel" />

@code {
    [Parameter] public bool Visible { get; set; }

    [Parameter] public InspectionForm? Form { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    [Parameter] public FormTable FormType { get; set; }



    private MudDataGrid<InspectionObjectView> InspectionObjectGrid;

    List<InspectionFormObject> _objects = new();

    List<InspectionObjectView> _objectsView = new();

    int _objPageSize = 10;

    int[] _objPageOptions = new[] { 10, 20, 50 };

    bool _dlgObject;

    string _objectType = string.Empty;

    string _objectName = string.Empty;

    string _objectCreator = string.Empty;

    DateTime? _objectCreatedAt = DateTime.Now;

    InspectionFormObject? _currentObject;

    Guid _targetObjectId;

    bool _openDetailsPanel;



    bool AllowAddDetail => FormType != FormTable.开班点检单 || Form != null || Form.Status == "开始";



    protected override async Task OnParametersSetAsync()

    {

        if (Visible && Form != null)

        {

            await ReloadObjects();

        }

    }



    async Task ReloadObjects()

    {

        var r = Db.Db.Queryable<InspectionFormObject>().Where(x => x.FormSysid == Form!.Sysid).ToList();

        _objects = r;

        _objectsView = _objects.Select(x => new InspectionObjectView
            {
                Sysid = x.Sysid,
                ObjectType = x.ObjectType,
                ObjectName = x.ObjectName,
                CheckResult = x.CheckResult,
                FormTemplateName = Form!.FormTemplateName,
                FormNo = Form!.FormNo,
                ProductName = Form!.ProductName,
                CreatedAt = Form!.TxnTime,
                CreateUser = Form!.CreateUser,
                WorkCenter = Form!.WorkCenter
            }).ToList();

        _currentObject = _objects.FirstOrDefault();

        _targetObjectId = _currentObject?.Sysid ?? Guid.Empty;

    }



    void NewObject()

    {

        if (Form == null) return;

        _objectType = string.Empty;

        _objectName = string.Empty;

        _objectCreator = string.Empty;

        _objectCreatedAt = DateTime.Now;

        _dlgObject = true;

    }



    async Task SaveObject()

    {

        if (Form == null) { _dlgObject = false; return; }

        var obj = new InspectionFormObject

            {

                Sysid = Guid.NewGuid(),

                FormSysid = Form.Sysid,

                ObjectType = _objectType,

                ObjectName = _objectName,

                CheckResult = "OK"

            };

        Db.Db.Insertable(obj).ExecuteCommand();

        _dlgObject = false;

        await ReloadObjects();

    }



    async Task<IEnumerable<string>> SearchObjectTypes(string value, CancellationToken _)

    {

        if (Form == null) return Enumerable.Empty<string>();

        return await Filter(await ConfigSvc.GetObjectTypesAsync(Form.FormTemplateName), value);

    }

    static Task<IEnumerable<string>> Filter(IEnumerable<string> src, string value)

    {

        var v = value ?? string.Empty;

        var items = src.Where(x => string.IsNullOrEmpty(v) || x.Contains(v,

        StringComparison.OrdinalIgnoreCase)).Take(10).ToList();

        return Task.FromResult(items.AsEnumerable());

    }



    void OnObjectRowClickView(DataGridRowClickEventArgs<InspectionObjectView> e)

    {

        var obj = _objects.FirstOrDefault(o => o.Sysid == e.Item.Sysid);

        if (obj != null)

        {

            _currentObject = obj;

            _targetObjectId = obj.Sysid;

            _openDetailsPanel = true;

        }

    }



    void Close()

    {

        OnClose.InvokeAsync();

    }

    void CloseDetailsPanel()

    {

        _openDetailsPanel = false;

    }
}

@code {
    public sealed class InspectionObjectView

    {

        public Guid Sysid { get; set; }

        public string ObjectType { get; set; } = string.Empty;

        public string ObjectName { get; set; } = string.Empty;

        public string CheckResult { get; set; } = string.Empty;

        public string FormTemplateName { get; set; } = string.Empty;

        public string FormNo { get; set; } = string.Empty;

        public string WorkCenter { get; set; } = string.Empty;

        public string ProductName { get; set; } = string.Empty;

        public DateTime? CreatedAt { get; set; }

        public string CreateUser { get; set; } = string.Empty;

        public string ObjectDisplayName => string.IsNullOrWhiteSpace(CheckResult) ? ObjectName : $"{ObjectName} ({CheckResult})";

    }
}
