@using global::InspectionSystem.Models
@using InspectionSystem.Services
@using InspectionSystem.Data
@using HmiInspection.Models
@namespace MudBlazorLab.Components.Components.InspectionPanel
@using MudBlazor
@inject IInspectionConfigService ConfigSvc
@inject InspectionSystem.Data.InspectionDb Db

<MudOverlay @bind-Visible="@Visible" DarkBackground="true" Class="d-flex align-center justify-center">
    <MudPaper Elevation="24" Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">对象：@(Form?.FormNo)</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(Form == null || Form.Status != "开始")"
                StartIcon="@Icons.Material.Filled.Add" OnClick="NewObject">新增对象</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Close">关闭</MudButton>
        </MudStack>
        <MudDataGrid @ref="InspectionObjectGrid" T="InspectionFormObject" Items="@_objects" Bordered="true" Dense="true"
            Hover="true" Filterable="true" FixedHeader="true" Height="65vh" RowsPerPage="@_objPageSize"
            RowClick="OnObjectRowClick" SortMode="SortMode.Multiple">
            <Columns>
                <PropertyColumn T="InspectionFormObject" TProperty="string" Property="@(x => x.ObjectType)"
                    Title="对象类型" />
                <PropertyColumn T="InspectionFormObject" TProperty="string" Property="@(x => x.ObjectName)"
                    Title="对象名称" />
                <TemplateColumn T="InspectionFormObject" Title="产线">
                    <CellTemplate Context="obj">
                        @Form?.ProductName
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn T="InspectionFormObject" TProperty="string" Property="@(x => x.CheckResult)"
                    Title="结果" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="InspectionFormObject" PageSizeOptions="@_objPageOptions" />
            </PagerContent>
        </MudDataGrid>
    </MudPaper>
</MudOverlay>

<MudDialog @bind-Visible="_dlgObject">
    <DialogContent>
        <MudStack Spacing="2">
            <MudAutocomplete T="string" @bind-Value="_objectType" Label="对象类型" Placeholder="对象类型"
                SearchFunc="SearchObjectTypes" CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />
            <MudTextField @bind-Value="_objectName" Label="对象名称" Placeholder="对象名称" Required="true" />
            <MudTextField @bind-Value="_objectCreator" Label="创建人" Placeholder="创建人" Required="true" />
            <MudDatePicker @bind-Date="_objectCreatedAt" Label="创建日期" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(() => _dlgObject = false)">取消</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveObject">确定</MudButton>
    </DialogActions>
</MudDialog>

<DetailsPanel Visible="_openDetailsPanel" CurrentDoc="Form" CurrentObject="_currentObject"
    OnClose="CloseDetailsPanel" />

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public InspectionForm? Form { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private MudDataGrid<InspectionFormObject> InspectionObjectGrid;
    List<InspectionFormObject> _objects = new();
    int _objPageSize = 10;
    int[] _objPageOptions = new[] { 10, 20, 50 };
    bool _dlgObject;
    string _objectType = string.Empty;
    string _objectName = string.Empty;
    string _objectCreator = string.Empty;
    DateTime? _objectCreatedAt = DateTime.Now;
    InspectionFormObject? _currentObject;
    Guid _targetObjectId;
    bool _openDetailsPanel;

    protected override async Task OnParametersSetAsync()
    {
        if (Visible && Form != null)
        {
            await ReloadObjects();
        }
    }

    async Task ReloadObjects()
    {
        var r = Db.Db.Queryable<InspectionFormObject>().Where(x => x.FormSysid == Form!.Sysid).ToList();
        _objects = r;
        _currentObject = _objects.FirstOrDefault();
        _targetObjectId = _currentObject?.Sysid ?? Guid.Empty;
    }

    void NewObject()
    {
        if (Form == null) return;
        _objectType = string.Empty;
        _objectName = string.Empty;
        _objectCreator = string.Empty;
        _objectCreatedAt = DateTime.Now;
        _dlgObject = true;
    }

    async Task SaveObject()
    {
        if (Form == null) { _dlgObject = false; return; }
        var obj = new InspectionFormObject
        {
            Sysid = Guid.NewGuid(),
            FormSysid = Form.Sysid,
            ObjectType = _objectType,
            ObjectName = _objectName,
            CheckResult = "OK"
        };
        Db.Db.Insertable(obj).ExecuteCommand();
        _dlgObject = false;
        await ReloadObjects();
    }

    async Task<IEnumerable<string>> SearchObjectTypes(string value, CancellationToken _)
    {
        if (Form == null) return Enumerable.Empty<string>();
        return await Filter(await ConfigSvc.GetObjectTypesAsync(Form.FormTemplateName), value);
    }
    static Task<IEnumerable<string>> Filter(IEnumerable<string> src, string value)
    {
        var v = value ?? string.Empty;
        var items = src.Where(x => string.IsNullOrEmpty(v) || x.Contains(v,
        StringComparison.OrdinalIgnoreCase)).Take(10).ToList();
        return Task.FromResult(items.AsEnumerable());
    }

    void OnObjectRowClick(DataGridRowClickEventArgs<InspectionFormObject> e)
    {
        _currentObject = e.Item;
        _targetObjectId = e.Item.Sysid;
        _openDetailsPanel = true;
    }

    void Close()
    {
        OnClose.InvokeAsync();
    }
    void CloseDetailsPanel()
    {
        _openDetailsPanel = false;
    }
}