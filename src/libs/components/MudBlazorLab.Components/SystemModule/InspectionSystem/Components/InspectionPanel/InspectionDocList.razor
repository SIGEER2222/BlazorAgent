@using global::InspectionSystem.Models
@using InspectionSystem.Data
@using InspectionSystem.Services
@using HmiInspection.Models
@namespace MudBlazorLab.Components.Components.InspectionPanel
@using MudBlazor
@inject IInspectionConfigService ConfigSvc
@inject InspectionSystem.Data.InspectionDb Db

<MudDataGrid @ref="InspectionDocGrid" T="InspectionForm" ServerData="LoadDocs" Bordered="true" Dense="true" Hover="true"
    Filterable="true" FixedHeader="true" Height="80vh" RowsPerPage="@_pageSize" RowClick="OnDocRowClick"
    SortMode="SortMode.Multiple">
    <ToolBarContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">表单</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NewDoc"
                StartIcon="@Icons.Material.Filled.Add">新增表单</MudButton>
        </MudStack>
    </ToolBarContent>
    <Columns>
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.FormNo)" Title="单号" />
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.FormTemplateName)" Title="模板" />
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.ProductName)" Title="产线" />
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.WorkCenter)" Title="工单" />
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.Status)" Title="状态">
            <CellTemplate Context="ctx">
                <MudChip Size="Size.Small" T="string" Color="@StatusColorText(ctx.Item.Status)"
                    Variant="Variant.Outlined">
                    @ctx.Item.Status
                </MudChip>
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.CreateUser)" Title="创建人" />
        <PropertyColumn T="InspectionForm" TProperty="DateTime?" Property="@(x => x.TxnTime)" Title="创建时间"
            Sortable="true" />
        <PropertyColumn T="InspectionForm" TProperty="string" Property="@(x => x.FormNo)" Title="操作">
            <CellTemplate Context="doc">
                <MudStack Row="true" Spacing="1">
                    <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Success" Size="Size.Small"
                        Disabled="@(doc.Item.Status!="创建")" OnClick="@(()=>StartForm(doc.Item))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Stop" Color="Color.Secondary" Size="Size.Small"
                        Disabled="@(doc.Item.Status!="开始")" OnClick="@(()=>EndForm(doc.Item))" />
                </MudStack>
            </CellTemplate>
        </PropertyColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="InspectionForm" PageSizeOptions="@_pageOptions" />
    </PagerContent>
</MudDataGrid>

<MudDialog @bind-Visible="_dlgDoc">
    <DialogContent>
        <MudStack Spacing="2">
            <MudAutocomplete T="string" @bind-Value="Form.Template" Label="模板" Placeholder="模板"
                SearchFunc="SearchTemplates" CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />
            <MudAutocomplete T="string" @bind-Value="Form.Line" Label="产线" Placeholder="产线" SearchFunc="SearchLines"
                CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />

            <GridDataGridSelect TItem="fab_work_order" Items="@_workOrderOptions" @bind-SelectedItems="Form.WorkOrders"
                DisplayTextSelector="@(p => p.WorkOrder)" Label="工单">
                <ColumnsTemplate>
                    <PropertyColumn T="fab_work_order" TProperty="string" Property="@(x => x.ProductName)"
                        Title="产品名称" />
                    <PropertyColumn T="fab_work_order" TProperty="string" Property="@(x => x.WorkOrder)" Title="工单号" />
                    <PropertyColumn T="fab_work_order" TProperty="string"
                        Property="@(x => x.PlanNedStartDate.ToString("yyyy-MM-dd"))" Title="计划开始时间" />
                    <PropertyColumn T="fab_work_order" TProperty="string"
                        Property="@(x => x.PlanNeddueDate.ToString("yyyy-MM-dd"))" Title="计划结束时间" />
                </ColumnsTemplate>
            </GridDataGridSelect>

            <MudTextField @bind-Value="Form.DocNumber" Label="单号" Placeholder="单号" Required="true" />
            <MudAutocomplete T="string" @bind-Value="Form.Creator" Label="创建人" Placeholder="创建人"
                SearchFunc="SearchCreators" CoerceText="true" CoerceValue="true" Clearable="true" Dense="true" />
            <MudDatePicker @bind-Date="Form.CreatedAt" Label="创建日期" />
            <MudSwitch T="bool" @bind-Value="Form.AutoStartAndCreateObject" Color="Color.Primary" Label="立即开始" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(() => _dlgDoc = false)">取消</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_canSubmitDoc)" OnClick="SaveDoc">确定
        </MudButton>
    </DialogActions>
</MudDialog>

<ObjectsPanel Visible="_openObjectsPanel" Form="_currentForm" OnClose="CloseObjectsPanel" />

@code {
    [Parameter] public string FormType { get; set; } = string.Empty;
    private MudDataGrid<InspectionForm> InspectionDocGrid;
    List<InspectionForm> _forms = new();
    int _pageSize = 10;
    int[] _pageOptions = new[] { 10, 20, 50 };
    bool _dlgDoc;
    InspectionForm? _currentForm;
    List<fab_work_order> _workOrderOptions = new();

    private sealed class DocFormState
    {
        public string Template { get; set; } = string.Empty;
        public string Line { get; set; } = string.Empty;
        public HashSet<fab_work_order> WorkOrders { get; set; } = new();
        public string DocNumber { get; set; } = string.Empty;
        public string Creator { get; set; } = string.Empty;
        public DateTime? CreatedAt { get; set; } = DateTime.Now;
        public bool AutoStartAndCreateObject { get; set; }
    }
    DocFormState Form = new();
    bool _canSubmitDoc => !string.IsNullOrWhiteSpace(Form.Template) && !string.IsNullOrWhiteSpace(Form.Line)
    && !string.IsNullOrWhiteSpace(Form.DocNumber) && !string.IsNullOrWhiteSpace(Form.Creator);
    bool _openObjectsPanel;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InspectionDocGrid.SetSortAsync(nameof(InspectionForm.TxnTime), SortDirection.Descending, x => x.TxnTime!.Value);
        }
    }

    async Task Reload()
    {
        _currentForm = await Db.Db.Queryable<InspectionForm>().OrderBy("TxnTime desc").FirstAsync();
        await InspectionDocGrid.ReloadServerData();
    }

    async Task NewDoc()
    {
        Form = new();
        var prefix = DateTime.Now.ToString("yyyyMMdd");
        var countToday = await Db.Db.Queryable<InspectionForm>().Where(x => x.FormNo.StartsWith(prefix)).CountAsync();
        Form.DocNumber = prefix + "." + (countToday + 1).ToString("D4");
        _dlgDoc = true;
        _workOrderOptions = (await ConfigSvc.GetWorkOrderNamesAsync()).ToList();
    }

    async Task SaveDoc()
    {
        var doc = new InspectionForm
        {
            Sysid = Guid.NewGuid(),
            FormTemplateName = Form.Template,
            FormNo = Form.DocNumber,
            FormType = FormType,
            ProductName = Form.Line,
            WorkCenter = string.Join(",", Form.WorkOrders.Select(x => x.WorkOrder)),
            CreateUser = Form.Creator,
            TxnTime = Form.CreatedAt ?? DateTime.Now,
            Status = "创建"
        };
        Db.Db.Insertable(doc).ExecuteCommand();
        _currentForm = doc;
        if (Form.AutoStartAndCreateObject)
        {
            await StartForm(doc);
        }
        _dlgDoc = false;

        var templateObj = await ConfigSvc.GetTemplateObjectsAsync(Form.Template);
        var lstObj = templateObj.Select(x => new InspectionFormObject
        {
            Sysid = Guid.NewGuid(),
            FormSysid = doc.Sysid,
            ObjectName = x.ObjectName,
            ObjectType = x.ObjectType,
            CheckResult = InspectionResult.OK.ToString()
        }).ToList();
        Db.Db.Insertable(lstObj).ExecuteCommand();

        await InspectionDocGrid.ReloadServerData();
    }

    async Task<IEnumerable<string>> SearchTemplates(string value, CancellationToken _) => await Filter(await
    ConfigSvc.GetTemplateNamesAsync(), value);
    async Task<IEnumerable<string>> SearchLines(string value, CancellationToken _) => await Filter(await
    ConfigSvc.GetProductionLineNamesAsync(), value);
    async Task<IEnumerable<string>> SearchCreators(string value, CancellationToken _) => await Filter(await
    ConfigSvc.GetCreatorNamesAsync(), value);
    static Task<IEnumerable<string>> Filter(IEnumerable<string> src, string value)
    {
        var v = value ?? string.Empty;
        var items = src.Where(x => string.IsNullOrEmpty(v) || x.Contains(v,
        StringComparison.OrdinalIgnoreCase)).Take(10).ToList();
        return Task.FromResult(items.AsEnumerable());
    }

    Color StatusColorText(string s) => s switch
    {
        "创建" => Color.Info,
        "开始" => Color.Success,
        "结束" => Color.Secondary,
        _ => Color.Default
    };

    async Task StartForm(InspectionForm doc)
    {
        doc.Status = "开始";
        Db.Db.Updateable(doc).ExecuteCommand();
    }
    async Task EndForm(InspectionForm doc)
    {
        doc.Status = "结束";
        Db.Db.Updateable(doc).ExecuteCommand();
    }

    void OnDocRowClick(DataGridRowClickEventArgs<InspectionForm> e)
    {
        _currentForm = e.Item;
        _openObjectsPanel = true;
    }

    void CloseObjectsPanel()
    {
        _openObjectsPanel = false;
    }

    async Task<GridData<InspectionForm>> LoadDocs(GridState<InspectionForm> state)
    {
        var q = Db.Db.Queryable<InspectionForm>();
        var data = await GridServerData.QueryAsync(q, state);
        _forms = data.Items.ToList();
        if (_currentForm == null) _currentForm = _forms.FirstOrDefault();
        return data;
    }
}