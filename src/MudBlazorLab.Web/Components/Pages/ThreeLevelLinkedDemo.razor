@page "/three-level-demo"
@using MudBlazor
@using MudBlazorLab.Components.Components
@using Bogus
@using System.Threading.Tasks
@inject IDialogService Dialog

<MudStack Spacing="2">
    <AutoDataGrid TItem="Dept" Title="一级：部门" Source="@_depts" Height="30vh" RowClick="@OnDeptRowClick">
        <Toolbar>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CreateDept">新建部门</MudButton>
        </Toolbar>
        <RowActions Context="dept">
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small"
                OnClick="@(() => AddProductFor(dept))">添加子项</MudButton>
        </RowActions>
    </AutoDataGrid>

    <AutoDataGrid TItem="Prod" Title="二级：产品" Height="30vh" RowClick="@OnProdRowClick" ServerData="@LoadProducts">
        <RowActions Context="prod">
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small"
                OnClick="@(() => AddItemFor(prod))">添加子项</MudButton>
        </RowActions>
    </AutoDataGrid>

    <AutoDataGrid @ref="_itemsGrid" TItem="Item" Title="三级：条目" Height="30vh" ServerData="@LoadItems">
    </AutoDataGrid>
</MudStack>

@code {
    class Dept { public int Id { get; set; } public string Name { get; set; } = string.Empty; }
    class Prod
    {
        public int Id { get; set; }
        public int DeptId { get; set; }
        public string Name { get; set; } =
        string.Empty;
    }
    class Item
    {
        public int Id { get; set; }
        public int ProdId { get; set; }
        public string Name { get; set; } =
        string.Empty; public int Quantity { get; set; }
        public decimal Price { get; set; }
    }

    List<Dept> _depts = new();
    List<Prod> _prods = new();
    List<Item> _items = new();
    int _deptSeq = 0, _prodSeq = 0, _itemSeq = 0;
    int? _selectedDeptId;
    int? _selectedProdId;
    AutoDataGrid<Item>? _itemsGrid;

    protected override void OnInitialized()
    {
        var fd = new Faker<Dept>("zh_CN").RuleFor(x => x.Id, f => ++_deptSeq).RuleFor(x => x.Name, f =>
        f.Commerce.Department());
        var fp = new Faker<Prod>("zh_CN").RuleFor(x => x.Id, f => ++_prodSeq).RuleFor(x => x.DeptId, f => f.Random.Int(1,
        50)).RuleFor(x => x.Name, f => f.Commerce.ProductName());
        var fi = new Faker<Item>("zh_CN").RuleFor(x => x.Id, f => ++_itemSeq).RuleFor(x => x.ProdId, f => f.Random.Int(1,
        1000)).RuleFor(x => x.Name, f => f.Commerce.ProductName()).RuleFor(x => x.Quantity, f => f.Random.Int(0,
        5000)).RuleFor(x => x.Price, f => f.Random.Decimal(1, 9999));

        _depts = fd.Generate(50);
        // 基于部门生成产品
        foreach (var d in _depts)
        {
            var count = Random.Shared.Next(10, 40);
            for (int i = 0; i < count; i++)
            {
                var p = fp.Generate();
                p.DeptId = d.Id;
                _prods.Add(p);
            }
        }
        // 基于产品生成条目
        foreach (var p in _prods)
        {
            var count = Random.Shared.Next(20, 60);
            for (int i = 0; i < count; i++)
            {
                var it = fi.Generate();
                it.ProdId = p.Id;
                _items.Add(it);
            }
        }
    }

    Task OnDeptRowClick(DataGridRowClickEventArgs<Dept> args)
    {
        _selectedDeptId = args.Item.Id;
        _selectedProdId = null;
        return Task.CompletedTask;
    }

    Task OnProdRowClick(DataGridRowClickEventArgs<Prod> args)
    {
        _selectedProdId = args.Item.Id;
        _itemsGrid?.Reload();
        return Task.CompletedTask;
    }

    Task<GridData<Prod>> LoadProducts(GridState<Prod> state)
    {
        var q = _prods.AsQueryable();
        if (_selectedDeptId.HasValue) q = q.Where(p => p.DeptId == _selectedDeptId.Value);
        var total = q.Count();
        var page = q.Skip(state.Page * state.PageSize).Take(state.PageSize).ToList();
        return Task.FromResult(new GridData<Prod> { Items = page, TotalItems = total });
    }

    Task<GridData<Item>> LoadItems(GridState<Item> state)
    {
        var q = _items.AsQueryable();
        if (_selectedProdId.HasValue) q = q.Where(i => i.ProdId == _selectedProdId.Value);
        var total = q.Count();
        var page = q.Skip(state.Page * state.PageSize).Take(state.PageSize).ToList();
        return Task.FromResult(new GridData<Item> { Items = page, TotalItems = total });
    }

    async Task CreateDept()
    {
        var prm = new DialogParameters();
        IDialogReference? dlg = await Dialog.ShowAsync<DynamicFormDialog<Dept>>("新建部门", prm);
        prm[nameof(DynamicFormDialog<Dept>.Model)] = new Dept();
        prm[nameof(DynamicFormDialog<Dept>.CancelAction)] = (Action)(() => dlg.Close());
        prm[nameof(DynamicFormDialog<Dept>.SubmitAction)] = (Action<Dept>)(m =>
        {
            m.Id = ++_deptSeq; _depts.Insert(0, m);
            dlg.Close(); StateHasChanged();
        });
    }

    async Task CreateProd()
    {
        if (!_selectedDeptId.HasValue) return;
        var defaults = new Dictionary<string, object?> { [nameof(Prod.DeptId)] = _selectedDeptId.Value };
        var prm = new DialogParameters();
        IDialogReference? dlg = await Dialog.ShowAsync<DynamicFormDialog<Prod>>("新建产品", prm);
        prm[nameof(DynamicFormDialog<Prod>.Model)] = new Prod { DeptId = _selectedDeptId.Value };
        prm[nameof(DynamicFormDialog<Prod>.Defaults)] = defaults;
        prm[nameof(DynamicFormDialog<Prod>.CancelAction)] = (Action)(() => dlg.Close());
        prm[nameof(DynamicFormDialog<Prod>.SubmitAction)] = (Action<Prod>)(m =>
        {
            m.Id = ++_prodSeq; _prods.Insert(0, m);
            dlg.Close(); StateHasChanged();
        });
    }

    async Task CreateItem()
    {
        if (!_selectedProdId.HasValue) return;
        var defaults = new Dictionary<string, object?> { [nameof(Item.ProdId)] = _selectedProdId.Value };
        var prm = new DialogParameters();
        IDialogReference? dlg = await Dialog.ShowAsync<DynamicFormDialog<Item>>("新建条目", prm);
        prm[nameof(DynamicFormDialog<Item>.Model)] = new Item { ProdId = _selectedProdId.Value };
        prm[nameof(DynamicFormDialog<Item>.Defaults)] = defaults;
        prm[nameof(DynamicFormDialog<Item>.CancelAction)] = (Action)(() => dlg.Close());
        prm[nameof(DynamicFormDialog<Item>.SubmitAction)] = (Action<Item>)(m =>
        {
            m.Id = ++_itemSeq; _items.Insert(0, m);
            _itemsGrid?.Reload(); dlg.Close(); StateHasChanged();
        });
    }

    async Task AddProductFor(Dept dept)
    {
        _selectedDeptId = dept.Id;
        await CreateProd();
    }

    async Task AddItemFor(Prod prod)
    {
        _selectedProdId = prod.Id;
        await CreateItem();
    }
}