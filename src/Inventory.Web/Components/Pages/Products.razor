@page "/master-data/products"
@using global::Inventory.Domain.Entities
@* 注入在代码段中声明 *@

<PageTitle>产品资料</PageTitle>

<MudStack Spacing="2">
    <MudText Typo="Typo.h5">产品资料</MudText>
    <MudPaper>
        <AutoDataGrid @ref="_grid" TItem="global::Inventory.Domain.Entities.Product" Title="产品列表" ServerData="LoadData" Height="70vh">
            <Toolbar>
                <MudTextField @bind-Value="_keyword" Placeholder="搜索代码/名称" Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_canCreate)" OnClick="TryNew" StartIcon="@Icons.Material.Filled.Add">新建</MudButton>
            </Toolbar>
            <RowActions Context="item">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(()=>Edit(item))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(()=>Delete(item))" />
            </RowActions>
        </AutoDataGrid>
    </MudPaper>
</MudStack>

@code {
    AutoDataGrid<global::Inventory.Domain.Entities.Product>? _grid;
    string? _keyword;

    async Task<GridData<global::Inventory.Domain.Entities.Product>> LoadData(GridState<global::Inventory.Domain.Entities.Product> state)
    {
        var page = state.Page + 1;
        var pageSize = state.PageSize;
        var (items, total) = await ProductSvc.QueryAsync(page, pageSize, _keyword);
        return new GridData<global::Inventory.Domain.Entities.Product> { Items = items.ToList(), TotalItems = total };
    }

    global::Inventory.Domain.Entities.Product _editing = new();
    bool _dialogOpen;
    bool _canCreate;

    void NewProduct()
    {
        _editing = new Product { Enabled = true };
        _dialogOpen = true;
    }

    void TryNew()
    {
        if (!_canCreate) { Snackbar.Add("当前账号无权限新建", Severity.Warning); return; }
         Snackbar.Add("开始新建", Severity.Info);
        NewProduct();
    }

    void Edit(global::Inventory.Domain.Entities.Product p)
    {
        _editing = new global::Inventory.Domain.Entities.Product { Id = p.Id, Code = p.Code, Name = p.Name, Category = p.Category, Unit = p.Unit, Enabled = p.Enabled };
        _dialogOpen = true;
    }

    async Task Delete(global::Inventory.Domain.Entities.Product p)
    {
        await ProductSvc.DeleteAsync(p.Id);
        _grid?.Reload();
    }
}

@using global::Inventory.Web.Components.Shared
<DynamicEditDialog Visible="_dialogOpen" Title="编辑产品" Model="_editing" Save="OnDialogSave" Cancel="OnDialogCancel" />

@code {
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Services.ProductService ProductSvc { get; set; } = default!;
    [Microsoft.AspNetCore.Components.Inject]
    MudBlazor.ISnackbar Snackbar { get; set; } = default!;
    [Microsoft.AspNetCore.Components.CascadingParameter]
    Task<Microsoft.AspNetCore.Components.Authorization.AuthenticationState> AuthTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await Task.Yield();
        _canCreate = true;
    }

    async Task Save()
    {
        if (_editing.Id == 0)
            await ProductSvc.CreateAsync(_editing);
        else
            await ProductSvc.UpdateAsync(_editing);
        _dialogOpen = false;
        _grid?.Reload();
    }

    Task OnDialogCancel() { _dialogOpen = false; return Task.CompletedTask; }
    Task OnDialogSave(object m)
    {
        if (m is Product p) _editing = p;
        return Save();
    }

    Task OnCheckedChanged(bool v)
    {
        _editing.Enabled = v;
        return Task.CompletedTask;
    }
}
@attribute [Authorize(Roles="Editor,Manager,Admin")]