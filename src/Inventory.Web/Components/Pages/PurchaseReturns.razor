@page "/purchase/returns"
@using global::Inventory.Domain.Entities

<PageTitle>采购退货</PageTitle>

<MudStack Spacing="2">
    <MudText Typo="Typo.h5">采购退货</MudText>
    <MudPaper>
        <AutoDataGrid @ref="_grid" TItem="PurchaseReturn" Title="退货单" ServerData="LoadData" Height="70vh">
            <Toolbar>
                <MudTextField @bind-Value="_keyword" Placeholder="搜索退货单号/供应商代码" Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NewReturn" StartIcon="@Icons.Material.Filled.Undo">新建退货</MudButton>
            </Toolbar>
            <RowActions Context="r">
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small" Disabled="@(r.Status!=ReturnStatus.Draft)" OnClick="@(()=>AddLine(r))" />
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary" Size="Size.Small" Disabled="@(r.Status!=ReturnStatus.Draft)" OnClick="@(()=>Process(r))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" Disabled="@(r.Status!=ReturnStatus.Draft)" OnClick="@(()=>Delete(r))" />
            </RowActions>
        </AutoDataGrid>
    </MudPaper>
</MudStack>

@attribute [Authorize(Roles="Manager,Admin")]

@code {
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Services.PurchaseReturnService ReturnSvc { get; set; } = default!;
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Services.ProductService ProductSvc { get; set; } = default!;
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Data.InventoryDb Db { get; set; } = default!;

    AutoDataGrid<PurchaseReturn>? _grid;
    string? _keyword;

    Task<GridData<PurchaseReturn>> LoadData(GridState<PurchaseReturn> state)
    {
        var page = state.Page + 1; var pageSize = state.PageSize;
        return ReturnSvc.QueryAsync(page, pageSize, _keyword).ContinueWith(t => new GridData<PurchaseReturn> { Items = t.Result.items.ToList(), TotalItems = t.Result.total });
    }

    PurchaseReturn _editing = new(); bool _dlgReturn;
    void NewReturn() { _editing = new PurchaseReturn { Status = ReturnStatus.Draft }; _dlgReturn = true; }
    async Task SaveReturn() { if (_editing.Id == 0) await ReturnSvc.CreateAsync(_editing); _dlgReturn = false; _grid?.Reload(); }

    bool _dlgLine; PurchaseReturn? _current; LineVm _line = new();
    class LineVm { public string ProductCode { get; set; } = string.Empty; public int WarehouseId { get; set; } = 0; public decimal Quantity { get; set; } = 0; public decimal UnitPrice { get; set; } = 0; }
    void AddLine(PurchaseReturn r) { _current = r; _line = new LineVm(); _dlgLine = true; }
    async Task SaveLine()
    {
        var p = await ProductSvc.FindByCodeAsync(_line.ProductCode);
        if (p == null || _current == null || _line.Quantity<=0 || _line.UnitPrice<0) { _dlgLine = false; return; }
        await ReturnSvc.AddLineAsync(new PurchaseReturnLine { PurchaseReturnId = _current.Id, ProductId = p.Id, WarehouseId = _line.WarehouseId, Quantity = _line.Quantity, UnitPrice = _line.UnitPrice });
        _dlgLine = false;
    }

    async Task Process(PurchaseReturn r) { var ok = await ReturnSvc.ProcessAsync(r.Id); _grid?.Reload(); }
    async Task Delete(PurchaseReturn r) { var ok = await ReturnSvc.DeleteAsync(r.Id); _grid?.Reload(); }

    Dictionary<int,string> _whDisplay = new();
    Task<IEnumerable<string>> SearchProductCodes(string value, CancellationToken _) { var list = Db.Products.Where(x => string.IsNullOrEmpty(value) || x.Code.Contains(value) || x.Name.Contains(value)).OrderBy(x=>x.Code).Select(x => x.Code).Take(10).ToList(); return Task.FromResult(list.AsEnumerable()); }
    Task<IEnumerable<int>> SearchWarehouses(string value, CancellationToken _) { var items = Db.Warehouses.Where(x => string.IsNullOrEmpty(value) || x.Code.Contains(value) || x.Name.Contains(value)).OrderBy(x=>x.Code).Select(x => new { x.Id, x.Code, x.Name }).Take(10).ToList(); _whDisplay = items.ToDictionary(d => d.Id, d => $"{d.Code} - {d.Name}"); return Task.FromResult(items.Select(d => d.Id).AsEnumerable()); }
    string ToWhString(int id) => _whDisplay.TryGetValue(id, out var s) ? s : id.ToString();
}

<MudDialog Visible="_dlgReturn">
    <DialogContent>
        <MudStack Spacing="2">
            <MudTextField @bind-Value="_editing.Code" Label="退货单号" Required="true" />
            <MudTextField @bind-Value="_editing.SupplierCode" Label="供应商代码" Required="true" />
            <MudTextField @bind-Value="_editing.Remark" Label="备注" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(()=>_dlgReturn=false)">取消</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveReturn">保存</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog Visible="_dlgLine">
    <DialogContent>
        <MudStack Spacing="2">
            <MudAutocomplete T="string" @bind-Value="_line.ProductCode" Label="产品代码" SearchFunc="SearchProductCodes" Dense="true" />
            <MudAutocomplete T="int" @bind-Value="_line.WarehouseId" Label="仓库" SearchFunc="SearchWarehouses" ToStringFunc="ToWhString" Dense="true" />
            <MudNumericField @bind-Value="_line.Quantity" Label="数量" Required="true" />
            <MudNumericField @bind-Value="_line.UnitPrice" Label="单价" Required="true" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(()=>_dlgLine=false)">取消</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveLine">保存</MudButton>
    </DialogActions>
</MudDialog>