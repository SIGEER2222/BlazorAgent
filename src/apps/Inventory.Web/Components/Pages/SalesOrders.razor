@page "/sales/orders"
@using global::Inventory.Domain.Entities

<PageTitle>销售订单</PageTitle>

<MudStack Spacing="2">
    <MudText Typo="Typo.h5">销售订单</MudText>
    <MudPaper>
        <AutoDataGrid @ref="_grid" TItem="SalesOrder" Title="订单列表" ServerData="LoadData" Height="70vh">
            <Toolbar>
                <MudTextField @bind-Value="_keyword" Placeholder="搜索订单号/客户代码" Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NewOrder" StartIcon="@Icons.Material.Filled.Add">新建订单</MudButton>
            </Toolbar>
            <RowActions Context="so">
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small" Disabled="@(so.Status!=SalesOrderStatus.Draft)" OnClick="@(()=>AddLine(so))" />
                <MudIconButton Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" Size="Size.Small" Disabled="@(so.Status!=SalesOrderStatus.Draft)" OnClick="@(()=>Approve(so))" />
                <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" Color="Color.Primary" Size="Size.Small" Disabled="@(so.Status!=SalesOrderStatus.Approved)" OnClick="@(()=>Ship(so))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" Disabled="@(so.Status!=SalesOrderStatus.Draft)" OnClick="@(()=>Delete(so))" />
            </RowActions>
        </AutoDataGrid>
    </MudPaper>
</MudStack>

@code {
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Services.SalesService SalesSvc { get; set; } = default!;
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Services.ProductService ProductSvc { get; set; } = default!;

    AutoDataGrid<SalesOrder>? _grid;
    string? _keyword;

    async Task<GridData<SalesOrder>> LoadData(GridState<SalesOrder> state)
    {
        var page = state.Page + 1; var pageSize = state.PageSize;
        var (items, total) = await SalesSvc.QueryAsync(page, pageSize, _keyword);
        return new GridData<SalesOrder> { Items = items.ToList(), TotalItems = total };
    }

    SalesOrder _editing = new();
    bool _dlgOrder;
    void NewOrder() { _editing = new SalesOrder { Status = SalesOrderStatus.Draft }; _dlgOrder = true; }
    async Task SaveOrder() { if (_editing.Id == 0) await SalesSvc.CreateAsync(_editing); _dlgOrder = false; _grid?.Reload(); }

    bool _dlgLine;
    SalesOrder? _current;
    LineVm _line = new();
    class LineVm { public string ProductCode { get; set; } = string.Empty; public int WarehouseId { get; set; } = 0; public decimal Quantity { get; set; } = 0; public decimal UnitPrice { get; set; } = 0; }
    void AddLine(SalesOrder so) { _current = so; _line = new LineVm(); _dlgLine = true; }
    async Task SaveLine()
    {
        var p = await ProductSvc.FindByCodeAsync(_line.ProductCode);
        if (p == null || _current == null || _line.Quantity<=0 || _line.UnitPrice<0) { _dlgLine = false; return; }
        await SalesSvc.AddLineAsync(new SalesOrderLine { SalesOrderId = _current.Id, ProductId = p.Id, WarehouseId = _line.WarehouseId, Quantity = _line.Quantity, UnitPrice = _line.UnitPrice });
        _dlgLine = false;
    }

    async Task Approve(SalesOrder so) { await SalesSvc.ApproveAsync(so.Id); _grid?.Reload(); }
    async Task Ship(SalesOrder so) { var ok = await SalesSvc.ShipAsync(so.Id); _grid?.Reload(); }
    async Task Delete(SalesOrder so) { var ok = await SalesSvc.DeleteAsync(so.Id); _grid?.Reload(); }
}

<MudDialog Visible="_dlgOrder">
    <DialogContent>
        <div data-testid="so-dialog">
        <MudStack Spacing="2">
            <MudTextField @bind-Value="_editing.Code" Label="订单号" Placeholder="订单号" Required="true" />
            <MudTextField @bind-Value="_editing.CustomerCode" Label="客户代码" Placeholder="客户代码" Required="true" />
            <MudTextField @bind-Value="_editing.Remark" Label="备注" />
        </MudStack>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(()=>_dlgOrder=false)">取消</MudButton>
        <div data-testid="so-save-btn"><MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveOrder">保存</MudButton></div>
    </DialogActions>
</MudDialog>

<MudDialog Visible="_dlgLine">
    <DialogContent>
        <div data-testid="so-line-dialog">
        <MudStack Spacing="2">
            <MudAutocomplete T="string" @bind-Value="_line.ProductCode" Label="产品代码" Placeholder="产品代码" SearchFunc="SearchProductCodes" Dense="true" />
            <MudAutocomplete T="int" @bind-Value="_line.WarehouseId" Label="仓库" Placeholder="仓库" SearchFunc="SearchWarehouses" ToStringFunc="ToWhString" Dense="true" />
            <MudNumericField @bind-Value="_line.Quantity" Label="数量" Placeholder="数量" Required="true" />
            <MudNumericField @bind-Value="_line.UnitPrice" Label="单价" Placeholder="单价" Required="true" />
        </MudStack>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(()=>_dlgLine=false)">取消</MudButton>
        <div data-testid="so-line-save-btn"><MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveLine">保存</MudButton></div>
    </DialogActions>
</MudDialog>
@attribute [Authorize(Roles="Manager,Admin")]

@code {
    [Microsoft.AspNetCore.Components.Inject]
    global::Inventory.Infrastructure.Data.InventoryDb Db { get; set; } = default!;
    Dictionary<int,string> _whDisplay = new();
    Task<IEnumerable<string>> SearchProductCodes(string value, CancellationToken _)
    {
        var list = Db.Products.Where(x => string.IsNullOrEmpty(value) || x.Code.Contains(value) || x.Name.Contains(value)).OrderBy(x=>x.Code).Select(x => x.Code).Take(10).ToList();
        return Task.FromResult(list.AsEnumerable());
    }
    Task<IEnumerable<int>> SearchWarehouses(string value, CancellationToken _)
    {
        var items = Db.Warehouses.Where(x => string.IsNullOrEmpty(value) || x.Code.Contains(value) || x.Name.Contains(value)).OrderBy(x=>x.Code).Select(x => new { x.Id, x.Code, x.Name }).Take(10).ToList();
        _whDisplay = items.ToDictionary(d => d.Id, d => $"{d.Code} - {d.Name}");
        return Task.FromResult(items.Select(d => d.Id).AsEnumerable());
    }
    string ToWhString(int id) => _whDisplay.TryGetValue(id, out var s) ? s : id.ToString();
}