name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test Inventory unit
        run: dotnet test tests/Inventory.Tests/Inventory.Tests.csproj --configuration Release --no-build

      - name: Test Factory unit
        run: dotnet test tests/Factory.Tests/Factory.Tests.csproj --configuration Release --no-build

      - name: Test Component (MudBlazorLab)
        run: dotnet test tests/MudBlazorLab.ComponentTests/MudBlazorLab.ComponentTests.csproj --configuration Release --no-build

      - name: Test Component (Inventory.Web)
        run: dotnet test tests/Inventory.ComponentTests/Inventory.ComponentTests.csproj --configuration Release --no-build

      - name: Test Component (Factory.Components)
        run: dotnet test tests/Factory.ComponentTests/Factory.ComponentTests.csproj --configuration Release --no-build

  e2e:
    runs-on: ubuntu-latest
    needs: [build-and-test, inventory-seed]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore

      - name: Publish Web (Inventory.Web)
        run: dotnet publish src/Inventory.Web/Inventory.Web.csproj -c Release -o publish

      - name: Install Playwright Browsers
        run: |
          dotnet tool install --global Microsoft.Playwright.CLI
          playwright install --with-deps

      - name: Start Web Server
        env:
          ASPNETCORE_URLS: http://localhost:5000
        run: |
          nohup dotnet ./publish/Inventory.Web.dll > server.log 2>&1 &
          sleep 5

      - name: Run E2E Tests
        env:
          BASE_URL: http://localhost:5000
        run: dotnet test tests/Inventory.E2E/Inventory.E2E.csproj -c Release

  factory-e2e:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore

      - name: Publish Web (Factory.Web)
        run: dotnet publish src/apps/Factory.Web/Factory.Web.csproj -c Release -o publish-factory

      - name: Start Factory Web Server
        env:
          ASPNETCORE_URLS: http://localhost:5000
        run: |
          nohup dotnet ./publish-factory/Factory.Web.dll > server-factory.log 2>&1 &
          sleep 5

      - name: Run Factory E2E Tests
        env:
          BASE_URL: http://localhost:5000
        run: dotnet test tests/Factory.E2E/Factory.E2E.csproj -c Release

  inventory-seed:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore

      - name: Run Inventory seed tests
        run: dotnet test tests/Inventory.Tests/Inventory.Tests.csproj --filter FullyQualifiedName~DataSeedTests.GenerateDemoData -c Release
