# 仓储（WMS）模块设计文档

## 目标与范围
- 目标：建立标准化 WMS，覆盖入库、上架、库存、内部作业、出库、盘点、报表与审计，支持策略配置与与现有工厂/计划/物流模块协同。
- 范围：单仓多库位；SKU/批次/序列号；载体（LPN/箱/托盘）；任务与劳动力调度；拣选/波次；盘点与差异；异常与审计；与 ERP/MES/TMS 轻量集成。
- 技术约束：沿用现有 Blazor Server + Minimal API + SqlSugar + Sqlite；服务端最小 API 分组 `"/api/wms"`；数据持久化使用 SqlSugar CodeFirst。

## 架构与边界
- UI：MudBlazor 组件构建页面，提供 CRUD、列表与操作面板。
- API：Minimal API 路由分组 `/api/wms`，所有写操作禁用防伪检查（后续可引入权限与令牌）。
- 仓储层：SqlSugar 实现为生产持久化；InMemory 实现用于测试与演示。
- 领域服务：Inbound、Inventory、Outbound、Counting、TaskDispatch、Replenishment 等按功能模块划分。

需求落实

- 仓库库位：支持容量（重量/数量）、容纳类型（允许物料/类别）、库位类型（收货/存储/拣选/发货）。
- 库存盘点：按物料维度查看各仓库/库位库存（重量/箱数），支持过滤与汇总。
- 库存调用：输入需求（n 箱铁片、m 箱铜片），给出从哪些仓库/库位调拨的计划（箱/托、路径）
UI 设计

- 位置管理（Locations）：配置库位属性（容量、容纳类型、库位类型），展示热力图/列表。
- 入库（Inbound）：创建入库单（自动单号），录入物料与数量（支持吨、箱），提交后直接入库位。
- 出库（Outbound）：创建出库单（自动单号），录入物料与需求（箱），生成拣选/发运任务。
- 库存盘点（Inventory）：按物料聚合显示各仓库/库位库存（重量/箱），支持筛选（物料/仓库/库位）。

流程设计

- 入库流程：IR→入库行→校验库位（容量/容纳类型）→入库位记账→库存盘点可见。
- 出库流程：OO→需求分配（优先拣选位/最短路径）→拣选/发运→库存扣减。
- 调用流程（跨库位/仓）：输入需求→查询可用库存→按策略（拣选位优先/最少拆分）生成调拨计划→提交生成调拨任务→执行扣减/增加。
数据模型（简化）

- wms_warehouse / wms_zone / wms_location ：包含 capacity_weight/capacity_qty/allowed_categories/type
- wms_inventory ： (item_id, warehouse_id, location_id, qty, uom, updated_at) 与 locked_qty
- wms_inbound_receipt / wms_inbound_line ：自动单号， (item_id, qty, uom)
- wms_outbound_order / wms_outbound_line ：自动单号， (item_id, qty, uom)
- wms_transfer_task ：调用生成的调拨任务（源库位、目标库位、数量/包装）
- 备注：物料与包装规格复用现有 Catalog（ Item.Category 、 PackSpec ），单位与包装转换内置。
API 契约（摘要）

- 主数据： GET/POST /api/wms/warehouses、/zones、/locations
- 入库： POST /api/wms/inbound （自动单号，JSON 行）， POST /api/wms/inbound/commit
- 出库： POST /api/wms/outbound （自动单号）， POST /api/wms/outbound/allocate/commit
- 库存： GET /api/wms/inventory?itemId&warehouseId&locationId （聚合/明细）
- 调用： POST /api/wms/call/plan （输入需求：铁片/铜片箱数，返回调拨方案）， POST /api/wms/call/commit
测试场景（异星工厂风格）

- 场景 A（入库）：A 仓收 10 吨铁（ iron-ore ，吨），B 仓收 200 箱铁片（ iron-plate ，箱）；库位容量校验与允许类型通过。
- 场景 B（盘点）：查看 iron-ore 与 iron-plate 的分布（仓/库位/数量/单位），总计与库位明细一致。
- 场景 C（调用）：需要 n 箱铁片与 m 箱铜片（ copper-plate ），系统返回“从 B 仓拣选位/存储位各调多少箱”的计划，尽量减少拆分并优先拣选位；提交后生成调拨任务与库存扣减/增加。

* 测试：bunit 做组件级单测；Playwright 做端到端 UI 测试
* 测试项目放到 工作区根目录/tests/目录下。测试需要另起终端执行命令

补充：可以对现有系统进行删改以满足以上需求，每次更改代码都要运行项目以查看效果，
新的界面不要忘记添加到导航菜单。

