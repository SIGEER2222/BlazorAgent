测试用例清单（M1–M5）

目标
- 形成分层测试用例库（单元/组件/E2E/属性/基准），覆盖 M1–M5 的关键能力与验收。
- 用例与代码位置、页面与端点双向可追溯，便于实现与CI集成。

总则
- 数据集：使用 `M1_设计文档.md` 提供的基础 JSON/CSV 数据集。
- 环境：本地 `http://localhost:5000/` 或 `http://localhost:5011/`（按项目运行配置）。
- 分层：单元（Domain/Simulation/Infrastructure）、组件（bunit，Blazor 组件）、E2E（Playwright）。

M1 — 基础域模型与仿真原型
- 单元
  - M1-U-01 配方守恒：输入减少量=输出增加量（`Recipe`）参考 `src/libs/factory/Factory.Domain/Entities/Recipe.cs:1-8`
  - M1-U-02 步进线性：非限电下 `ElapsedSeconds` 与产出近似线性参考 `src/libs/factory/Factory.Simulation/Engine/SimulationEngine.cs:25-52`
  - M1-U-03 能耗一致性：`TotalEnergyKWh` 按批次与 `powerKw*timeSeconds/3600` 累加参考 `SimulationEngine.cs:25-52`
  - M1-U-04 限电缩放：`PowerDomainKw` 小于总功率时吞吐按比例缩放参考 `SimulationEngine.cs:25-52`
  - M1-U-05 库存变更：`Seed/Step` 后 `Inventory/Produced` 更新正确参考 `SimulationEngine.cs:25-52`
  - M1-U-06 导入校验：非法 `itemId`、`amount<=0`、`timeSeconds<=0`、`powerKw<0` 返回错误清单（实现于导入端点后）
- 组件（bunit）
  - M1-C-01 设计器运行控件：`Start/Pause/Step` 状态与步长滑块联动参考 `src/apps/Factory.Web/Components/Pages/FactoryDesigner.razor:1-20,81-107`
  - M1-C-02 库存表渲染：步进后 `Inventory` 表数据更新参考 `FactoryDesigner.razor:21-38`
  - M1-C-03 报表吞吐：`Produced/ElapsedSeconds` 计算与显示参考 `src/apps/Factory.Web/Components/Pages/FactoryReports.razor:1-35`
- E2E（Playwright）
  - M1-E-01 导入→种子→步进→吞吐为正；访问 `/reports` 验证吞吐≈1/s（铁板示例）参考 `SimulationEngine.cs:25-52`
  - M1-E-02 API 可用性：`GET /api/items`、`GET /api/recipes`、`GET /api/sim/metrics` 返回期望结构参考 `src/apps/Factory.Web/Program.cs:39-47`

M2 — 物流网络与能源系统、蓝图参数化
- 单元
  - M2-U-01 分流优先级：`SplitNode` PriorityFirst 分配符合容量参考 `src/libs/factory/Factory.Simulation/Engine/TransportNetwork.cs:1-60`
  - M2-U-02 分流轮询：`SplitNode` RoundRobin 轮询分配正确参考 `TransportNetwork.cs:43-72`
  - M2-U-03 合流守恒：`MergeNode` 输出不超过容量且守恒参考 `TransportNetwork.cs:74-88`
  - M2-U-04 反压传播：下游拥塞时上游排空速率下降（基于缓冲与容量模型）参考 `TransportNetwork.cs:1-88`
  - M2-U-05 降频策略：功率超限时有效秒数缩放参考 `SimulationEngine.cs:25-52`
  - M2-U-06 燃料不足停机：熔炉无燃料时停机（实现后校验）
- 组件（bunit）
  - M2-C-01 物流热力图：颜色映射与图例正确（速率/拥塞）
  - M2-C-02 电力覆盖图层：供电域切换正确（待实现）
  - M2-C-03 产线仪表盘：行级吞吐/能耗/饥饿时间与设备清单动态增删
- E2E（Playwright）
  - M2-E-01 构建多线物流→观察拥塞→调整优先级→吞吐改善
  - M2-E-02 限电 50%→吞吐约减半；恢复后回升参考 `SimulationEngine.cs:25-52`
  - M2-E-03 燃料耗尽→熔炉停机→吞吐下降与饥饿时间上升；补充燃料后恢复

M3 — 科技树、订单规划与瓶颈分析
- 单元
  - M3-U-01 研究依赖闭包与拓扑排序正确（待实现）
  - M3-U-02 订单→方案映射可行性判定正确（最短路径/最大流，待实现）
  - M3-U-03 瓶颈定位：最小 Slack/最大利用率一致（待实现）
  - M3-U-04 良率影响：有效产能=名义产能×有效良率，产出与报废统计一致（待实现）
- 组件（bunit）
  - M3-C-01 科技树展开/折叠、队列增删与进度渲染正确
  - M3-C-02 规划视图差距与建议列表渲染与过滤正确
- E2E（Playwright）
  - M3-E-01 创建订单→生成方案 `<2s`→运行仿真→查看建议→应用建议→吞吐提升≥15%
  - M3-E-02 拉/推切换：拉式交期满足率达标；推式持有成本下降且服务水平≥目标
  - M3-E-03 良率 0.9：产出与报废统计一致，有效产能与吞吐吻合

M4 — 列车与跨区物流、地图与污染、蓝图市场
- 单元
  - M4-U-01 路径规划：障碍/地形约束下最短/最快路径正确（待实现）
  - M4-U-02 时刻表冲突检测与解决策略稳定（待实现）
  - M4-U-03 蓝图分享 JSON Schema 校验与版本更新正确（待实现）
- 组件（bunit）
  - M4-C-01 线路编辑与时刻表渲染；冲突标识与提示
  - M4-C-02 地图图层叠加与选择；框选细节展示
  - M4-C-03 市场条目列表与评分展示
- E2E（Playwright）
  - M4-E-01 构建跨区物流→列车运行→资源收发→冲突场景提示与修复
  - M4-E-02 蓝图上传（不合规被拒并返回错误详情/合规成功）→下载→参数化部署

M5 — 性能与稳定性、导出与扩展
- 单元
  - M5-U-01 诊断指标采集与聚合正确（TPS/P95/CPU/Memory/GC/DroppedTicks，待实现端点）
  - M5-U-02 导出字段映射与格式校验（CSV/Excel，包含血缘元数据）
  - M5-U-03 扩展点注册与生命周期事件（注册/拒绝/隔离运行）
- E2E（Playwright）
  - M5-E-01 大规模仿真→注入故障（限电/丢包/延迟）→观察稳态与恢复时间
  - M5-E-02 导出报告字段与单位正确、含元数据；抽样与页面一致
  - M5-E-03 扩展注册：不合规载荷被拒并返回错误详情；合规载荷注册成功并隔离运行
- 基准
  - M5-B-01 `N=1k/10k/100k` 节点场景下 TPS/Memory/Latency 曲线采集与回归对比

API 契约测试（横向）
- A-01 端点状态码与结构：`/api/items`、`/api/recipes`、`/api/sim/metrics`（参考 `src/apps/Factory.Web/Program.cs:39-47`）
- A-02 蓝图端点：`POST /api/blueprints`、`GET /api/blueprints/{id}`、`POST /api/factories/{id}/deploy`（参考 `src/apps/Factory.Web/Program.cs:49-67`）
- A-03 导入端点：`POST /api/catalog/import` 成功/失败错误结构（新增后执行）
- A-04 错误形态与追踪：统一错误结构携带 `traceId`（新增后执行）

日志/审计与可观测性（横向）
- O-01 结构化日志包含 `traceId/userId/type/object/content`（参考 `src/libs/components/MudBlazorLab.Components/Models/LogEntry.cs:12-18`，扩展字段后执行）
- O-02 每次写操作产生审计事件并可检索（新增后执行）
- O-03 诊断采样窗口与节流不影响核心吞吐（M5 实现后执行）

页面与导航（E2E 快速验证）
- P-01 设计器 `/factory`：Start/Pause/Step 控件与库存/画布渲染（参考 `FactoryDesigner.razor:1-107`）
- P-02 报表 `/reports`：吞吐计算与表格渲染（参考 `FactoryReports.razor:1-35`）
- P-03 M2–M5 新页面路由与基本渲染（页面新增后执行）

