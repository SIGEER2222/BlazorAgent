目标与范围

- 搭建“异星工厂”式流水作业系统：资源采集→中间件加工→高阶产物→订单交付的全链路。
- 支持工厂设计、生产调度、物流网络、能耗与科技树演进，并可扩展至多人协作与蓝图复用。
- 首期聚焦可视化编排与稳定仿真，提供可度量的产能、能耗、库存、交付时间等关键指标。
核心功能

- 物料与配方管理：定义基础物料、配方输入产出、时长与能耗、副产物与概率。
- 设备与模块：采矿机、熔炉、组装机、化工机、实验室；支持效率/速度/能耗模块。
- 物流网络：传送带、机械臂、管道、仓储、列车（后期）；缓冲区与优先级策略。
- 能源系统：发电机、供电范围、线路负载、耗能测算与限电策略。
- 科技树：研究点产出、科技解锁设备/配方/模块；研究队列与依赖。
- 生产调度：订单驱动与配方驱动两种模式，支持目标产能、节拍、瓶颈识别与优化建议。
- 蓝图与复用：蓝图保存/分享/参数化部署，支持镜像与旋转。
- 地图与布局：网格化地图、地形资源分布、障碍与污染（可选），路径与连线校验。
- 指标与报表：产能、WIP、库存、能耗、良率、交付率、单位成本、碳排（可选）。
角色与场景

- 工程师：设计工厂、编排产线与物流、调试配方与参数。
- 经理：下达订单目标、查看报表、进行产能与成本评估。
- 管理员：维护科技、设备库与权限策略；管理蓝图仓库。
- 观察者：只读查看工厂状态与指标。
系统架构

- 应用层（Blazor Server）： src/apps/Factory.Web （与现有 Inventory.Web 并行，后续可独立或集成）。
- 领域库： src/libs/factory/Factory.Domain （物料/配方/设备/蓝图/订单等领域模型）。
- 仿真引擎： src/libs/factory/Factory.Simulation （离散事件/固定 tick 调度、网络拓扑与流量计算）。
- 基础设施： src/libs/factory/Factory.Infrastructure （持久化、仓储、数据导入导出）。
- UI 组件库： src/libs/components/Factory.Components （画布、蓝图编辑器、图层面板、报表组件）。
- 演示站点与样例： samples/Factory.Web （蓝图示例、教学场景与脚本）。
数据模型（示例）

- Item ： id 、 name 、 category 、 stackSize
- Recipe ： id 、 inputs[] 、 outputs[] 、 time 、 power
- Machine ： id 、 type 、 speed 、 powerUsage 、 modules[]
- Belt/Inserter/Pipe ： speed 、 capacity 、 latency 、 direction
- Factory ： id 、 gridSize 、 entities[] 、 links[] 、 blueprints[]
- Order ： id 、 items[] 、 due 、 priority 、 status
- Research ： id 、 cost[] 、 unlocks[] 、 deps[]
- Report ： timestamp 、 metrics{throughput,energy,inventory,wip,cost}
界面导航

- 总览仪表盘：今日产能、能耗、订单状态、瓶颈提示与优化建议。
- 工厂设计器：网格画布编辑、设备/蓝图放置、连线与约束校验、图层与对齐辅助。
- 配方与物料：配方浏览、依赖查询、可解锁条件、能耗与时长对比。
- 设备与模块：设备库参数、模块效果叠加、能耗/效率模拟。
- 物流网络：带/臂/管流量热力图、拥塞点定位、分流/合流策略。
- 能源与电网：电力覆盖、负载曲线、限电方案与影响。
- 科技研究：科技树图、研究队列、产出速率与预估时间。
- 蓝图管理：保存、复用、版本与参数化部署，蓝图市场（可选）。
- 订单与计划：目标设定、节拍/交付预测、紧急订单插队策略。
- 报表中心：产能、WIP、库存周转、能耗、单位成本、交期曲线。
- 设置与权限：用户角色、可视范围、演示/真实模式切换。
关键交互

- 拖拽设备与蓝图放置，自动对齐与连线建议；冲突与约束即时提示。
- 一键识别瓶颈与改线建议（如提高带速、更换组装机等级、增添分流）。
- 仿真播放/暂停/单步、速度调节；数据快照与对比。
- 订单驱动仿真：目标件/时或件/批；自动生成产线方案；显示差距与优化路径。
- 蓝图参数化：输入配方等级/模块数量/带速，输出可布置的蓝图实例。
仿真引擎

- Tick 调度（默认 60 TPS 可调）：设备生产、物流传输、能耗累积、研究进度。
- 网络拓扑与流量计算：带/臂/管速率、队列容量、延迟与掉包；拥塞反压传播。
- 能耗与供电：设备功耗曲线、供电域覆盖、负载超限降频策略。
- 可插拔策略：调度器与优化器接口，支持不同优先级和约束逻辑。
算法与调度

- 订单到产线映射：拓扑优化（最短路径/最大流）、瓶颈定位（约束分析）。
- 蓝图布局启发式：网格分区、邻近性与带长最小化、拥塞避免。
- 参数优化：模块组合搜索（局部搜索/模拟退火/遗传算法可选）。
- 研究队列优化：基于收益/时间比的选择与依赖满足。
存储与扩展

- 持久化：工厂、蓝图、配方、设备库、订单、研究、报表。
- 导入/导出：蓝图 JSON、报表 CSV/Excel。
- 扩展点：设备/配方/模块注册、地图地形与资源生成器

API 设计（示例）

- 物料与配方： GET /api/items 、 GET /api/recipes?item=... 、 POST /api/recipes
- 工厂与蓝图： GET /api/factories/{id} 、 POST /api/blueprints 、 POST /api/factories/{id}/deploy
- 仿真控制： POST /api/sim/{factoryId}/start|pause|step 、 GET /api/sim/{factoryId}/metrics
- 订单与计划： POST /api/orders 、 GET /api/orders/{id} 、 POST /api/plans/generate
- 科技与研究： GET /api/research/tree 、 POST /api/research/queue
- 报表与导出： GET /api/reports/throughput 、 GET /api/reports/export?type=excel
测试与质量

- 单元测试：领域模型与配方计算、仿真步进与能耗一致性、调度策略。
- 组件测试（bunit）：画布交互、蓝图面板、指标图表。
- 端到端（Playwright）：工厂搭建→仿真运行→报表验证→蓝图保存/复用。
- 属性测试：流量守恒、能耗核算、稳态识别、优先级策略不变式。
- 基准测试：不同带速/设备规模下的仿真性能与内存占用。
里程碑

- M1 基础域模型与配方库、画布原型、简单仿真（单线带→组装机→出料）、报表初版。
- M2 物流网络（合流/分流/优先级）、能耗系统与供电域、蓝图保存与参数化部署。
- M3 科技树与研究、订单驱动产能规划、瓶颈分析与优化建议。
- M4 高级功能（列车与跨区物流、地形资源与污染）、蓝图市场与分享。
- M5 性能与稳定性专项、数据导出与报告完善、脚本化与扩展接口。

框架与技术：
如有必要，可以引入第三方库做ui和逻辑计算。

输出要求
- 若遇错误，定位堆栈源文件位置并当场修复与复测
- 每次改动后必须运行项目并告知可验证的页面
- 尽量减少与我交互的次数，只在必要时才与我沟通。

在现有 项目与库结构（ src/apps/Factory.Web 、 src/libs/factory/* 、 src/libs/components/Factory.Components ），并落地首期 M1 的最小可用版本。并在后续的每一阶段输出设计文档到目录 .trae/Factory/documents/ 下。

指标定义（补充）
- Cycle Time（CT）：完成一个单位产品的平均加工时间（不含等待），按工位并行度折算。
- Lead Time（LT）：从下单到交付的总时间（加工+排队+物流），用于交期评估。
- Takt Time：满足需求节拍的标准时间，`takt = availableTime / customerDemand`。
- Capacity：名义产能为各阶段能力的最小值；有效产能=名义产能×有效良率。
- Yield（良率）：合格品占比；`scrapRate = 1 - yieldRate`，影响有效吞吐与成本。
- Service Level：交期满足比例或缺货概率目标（例如≥95%）。

扩展主题（仓储、工单与市场经济）

- 仓储与成本：
  - 指标：库存持有成本（单位时间/单位数量）、缺货成本、服务水平（满足率）、周转率。
  - 目标：在规划与仿真中最小化总成本（持有+缺货+能耗），约束交期与吞吐。
  - API（示例）：
    - GET `/api/warehouse/stock?factoryId=...` → `[{ itemId, onHand, reserved, safetyStock }]`
    - GET `/api/warehouse/costs` → `{ holdingPerUnitPerHour, shortagePerUnit, serviceLevelTarget }`
- 工单模式（拉/推）：
  - 拉式：订单驱动，按目标节拍与交付预测生成产线方案与派工；看板/再订货点策略。
  - 推式：经验/策略驱动生产，依据历史与预测补货；需求噪声与安全库存。
  - API（示例）：
    - POST `/api/workorders` → `{ id, mode:"pull|push", items:[{itemId, qty}], due?, priority }`
    - GET `/api/workorders/{id}` → 工单状态与关联产线。
- 市场与经济系统：
  - 市场订单：定期发布可出售/采购的物资订单；成交价格与数量影响预算。
  - 预算与资产：余额、设备资产、土地（资源地/空地）持有；设备升级影响产能/良率。
  - API（示例）：
    - GET `/api/market/orders` → `[{ id, type:"buy|sell", itemId, qty, price, expiresAt }]`
    - POST `/api/market/trade` → 提交交易，更新库存与预算。
    - GET `/api/economy/budget` → `{ balance, assets{ machinesValue, landValue }, income, expenses }`
    - POST `/api/economy/purchase/machine` → 购买/升级设备（影响 `speed/quality/power`）。
    - POST `/api/economy/purchase/land` → 购买土地（资源地/空地），更新地图与可建设区域。
