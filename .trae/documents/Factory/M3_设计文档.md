M3 设计文档 — 科技树、订单驱动产能规划与瓶颈分析

范围与目标
- 科技树：研究点产出、解锁设备/配方/模块；研究队列与依赖管理。
- 订单驱动：目标产能/节拍与交付预测；自动生成产线方案。
- 瓶颈分析：约束定位与优化建议（提高带速/更换组装机等级/增添分流）。
- 仓储成本与工单模式：在规划中最小化库存持有与缺货成本；支持拉/推工单。
 - 周期与交期：纳入生产周期（Cycle Time）与交期（Due）约束，提供交付风险评估与加急建议。
 - 产能与良率：按产线与设备计算名义/有效产能，引入良率（Yield）与报废（Scrap）对吞吐的影响。

数据模型（细化）
- ResearchNode：`{ id, name, cost{itemId→amount}, unlocks{recipes[], machines[], modules[]}, deps[] }`
- ResearchQueue：`{ items: ResearchNodeId[], progress: { nodeId→0..1 } }`
- Order：`{ id, items[{ itemId, quantity }], due, priority, status:"pending|in_progress|done" }`
  - 可选：`serviceLevelTarget?`（例如 95%）
- Plan：`{ id, orderId, targetTakt(items/s), lines[{ lineId, targetItemId, machines[] }], feasibility:true|false, gaps[{ itemId, demand, supply, delta }] }`
  - 经济维度：`costs{ holding, shortage, energy, labor? }`、`budgetImpact{ income?, expense? }`
  - 周期与交期：`ctSeconds`（Cycle Time）、`ltSeconds`（Lead Time）、`dueRisk:"low|medium|high"`、`promiseDate`（预计交付日期）
- Bottleneck：`{ entityId|edgeId, type:"machine|belt|power|fuel", utilization, slack, suggestion }`
- Suggestion：`{ action:"upgrade|add|split|priority|power|fuel", targetId, expectedGain, cost }`

 仓储与工单（新增）
- Warehouse：`{ itemId, onHand, reserved, safetyStock, holdingCostPerUnitPerHour }`
- WorkOrder：`{ id, mode:"pull|push", items[{itemId, qty}], due?, priority, status }`
- Policies：`{ reorderPoint, kanbanCards, forecastHorizon }`
 - YieldModel（良率）：
   - `ProcessYield`：`{ recipeId, yieldRate(0..1), scrapItemId?, reworkable:boolean }`
   - `LineYield`：`{ lineId, effectiveYield(0..1), scrapRate(0..1) }`

接口契约（含示例）
- GET `/api/research/tree` → `ResearchNode[]`
- POST `/api/research/queue`
  - 请求：`{ add:[nodeId], remove:[nodeId] }`
  - 返回：`{ queue:[nodeId], progress:{ nodeId:0..1 } }`
- POST `/api/orders`
  - 请求：`{ items:[{itemId, quantity}], due, priority }`
  - 返回：`{ id, status:"pending" }`
- GET `/api/orders/{id}` → `Order`
- POST `/api/plans/generate`
  - 请求：`{ orderId, constraints:{ powerKw?, fuelRate?, beltSpeed? }, objective:"min_time|min_cost|max_throughput" }`
  - 返回：`Plan`（含 `feasibility`、`gaps`、`costs` 与 `budgetImpact`）
- GET `/api/plans/{id}/bottlenecks` → `Bottleneck[]`
- GET `/api/plans/{id}/suggestions` → `Suggestion[]`
- GET `/api/warehouse/stock` → `Warehouse[]`
- GET `/api/warehouse/costs` → `{ holdingPerUnitPerHour, shortagePerUnit, serviceLevelTarget }`
- POST `/api/workorders` → 创建拉/推工单；GET `/api/workorders/{id}` → 工单状态
 - GET `/api/plans/{id}/capacity` → `{ lineId→capacityItemsPerSecond }`
 - GET `/api/plans/{id}/yield` → `{ recipeId→yieldRate, lineId→effectiveYield }`
 - GET `/api/plans/{id}/schedule` → `{ ctSeconds, ltSeconds, promiseDate, dueRisk }`

算法与策略（实现指引）
- 科技树
  - 依赖闭包与拓扑排序；进度计算按 `researchRate` 与 `cost` 比例推进。
  - 解锁应用：更新可用 `recipes/machines/modules` 并影响规划搜索空间。
- 订单规划
  - 需求分解：将订单转化为目标产物的产线需求与配方链路。
  - 拓扑优化：在网络上进行最大流/最短路径，结合设备等级与带速。
  - 节拍匹配：计算各环节节拍，识别最紧约束（瓶颈）。
- 成本优化：目标函数 `min(holding + shortage + energy)`，约束交期与吞吐；支持拉/推模式差异（拉→严格交期，推→更高安全库存）。
 - 周期与交期：
   - `ct = Σ stationProcessTime / parallelism`（按并行度折算）；`lt = ct + queueingDelay + logisticsDelay`。
   - 交期风险：若 `currentTime + lt > due`，按差距分级（low/medium/high），生成加急建议（提高带速、升级设备、增设并行、调整优先级）。
 - 产能计算：
   - 名义产能：`capacity_nominal = min(stage_i_rate)`；有效产能：`capacity_effective = capacity_nominal * effectiveYield`。
   - 良率：在 `Step` 推进中对 `outputs` 乘以 `yieldRate`；剩余按 `scrapRate` 计入报废或返修流。
- 瓶颈分析
  - 利用率 `u = demand / capacity`，Slack = `capacity - demand`；取最小 Slack 为瓶颈。
  - 建议生成：对瓶颈应用可行动作（升级设备、增加分流、提高优先级、提升电力域或燃料供给），估算 `expectedGain` 与 `cost`。

UI 与交互（页面）
- `ResearchTree`（`/factory/research`）：树图展示依赖与解锁；队列管理；进度条。
- `PlanningView`（`/factory/planning`）：订单选择、目标设定、方案与差距展示；瓶颈与建议列表。
  - 成本面板：展示持有/缺货/能耗成本；切换 `objective` 与拉/推模式；查看预算影响。
  - 周期与交期：展示 `ct/lt/promiseDate/dueRisk`；高风险时突出加急建议。
  - 产能与良率：展示 `capacity_nominal/effectiveYield/capacity_effective`，并在行级卡片显示。
- `Orders`（`/factory/orders`）：订单创建与状态跟踪。
- `Warehouse`（`/factory/warehouse`，可选）：库存与成本参数查看、策略配置（再订货点/看板）。

测试方案（细化）
- 单元测试
  - 科技依赖闭包与拓扑排序正确；解锁集更新一致。
  - 订单→计划映射可行性判断正确；目标节拍与需求分解一致。
  - 瓶颈定位：最小 Slack/最大利用率点一致；建议的方向性正确。
- 组件测试（bunit）
  - 科技树的展开/折叠与进度渲染；队列增删交互。
  - 规划视图的差距/建议列表渲染与过滤。
- 端到端（Playwright）
  - 流程：创建订单→生成方案→运行仿真→查看瓶颈建议→应用建议→吞吐改善。
  - 断言：应用建议后瓶颈处 `u` 下降，吞吐提升或能耗权衡明确。
- 属性测试
  - 约束紧缩时可行性单调不增；放宽约束时可行性单调不减。
  - 建议的 `expectedGain` 不小于实际观测增益的下界。
- 基准测试
  - 不同订单规模与拓扑复杂度下的生成耗时曲线；方案稳定性与仿真效率。

验收标准（量化）
- 科技树解锁与研究队列工作稳定，进度与解锁一致。
- 订单到方案生成在中等规模下 `< 2s`，瓶颈与建议可用。
- 成本面板与模式切换生效；拉式方案交期满足率符合目标，推式方案持有成本降低并保持服务水平。
 - 周期与交期：`ct/lt` 计算与仿真观测一致（误差在容忍阈内）；`dueRisk` 与建议生成逻辑正确。
 - 产能与良率：有效产能与吞吐观测一致；良率变化能反映在产出与报废统计中。
- 应用建议后，吞吐提升或成本/能耗权衡被明确展示。

可验证页面
- `/factory/research`
- `/factory/planning`
- `/factory/orders`

服务与职责
- 应用/API（`Factory.Web`）
  - `ResearchController`：科技树读取、研究队列管理。
  - `OrdersController`：订单创建、状态查询。
  - `PlanningController`：产线方案生成与差距分析。
- 领域服务（`Factory.Domain`）
  - `ResearchService`：科技树模型与解锁逻辑、收益/时间比排序。
  - `OrdersService`：订单与目标件/时、优先级策略。
  - `PlanningService`：拓扑优化（最短路径/最大流）、节拍匹配。
  - `OptimizationService`：瓶颈识别与建议生成。
- 仿真引擎（`Factory.Simulation`）
  - `Planner`：订单到产线映射与节拍仿真。
  - `BottleneckAnalyzer`：约束分析与方案比较。
- 基础设施（`Factory.Infrastructure`）
  - `ResearchStore`：科技树持久化与依赖检查。
  - `OrdersStore`：订单/计划/报告持久化。
- UI 组件（`Factory.Components`）
  - `ResearchTree`：科技树图与队列管理面板。
  - `PlanningView`：目标设定、预测曲线与建议列表。

接口设计（示例）
- GET `/api/research/tree`
- POST `/api/research/queue`
- POST `/api/orders`
- GET `/api/orders/{id}`
- POST `/api/plans/generate`

测试方案
- 单元测试
  - 研究依赖闭包与拓扑排序正确性。
  - 订单节拍→产线方案的映射正确与可行性校验。
  - 瓶颈定位：约束最紧节点/边识别一致性。
- 组件测试（bunit）
  - 科技树展开/折叠交互与解锁状态渲染。
  - 规划视图差距与建议展示。
- 端到端（Playwright）
  - 流程：创建订单→生成方案→运行仿真→查看建议→方案对比。
- 属性测试
  - 优化建议对吞吐/能耗的方向性正确（改善或权衡明确）。
- 基准测试
  - 不同订单规模下的规划耗时与仿真效率。

验收标准
- 科技树与研究队列工作稳定，解锁逻辑正确。
- 订单驱动的方案生成与瓶颈分析可靠。

可验证页面
- `/factory/research`
- `/factory/planning`
- `/factory/orders`
