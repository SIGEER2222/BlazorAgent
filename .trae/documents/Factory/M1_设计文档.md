M1 设计文档 — 基础域模型与配方导入、仿真原型（细化版）

范围与目标
- 完成基础域模型（Item/Recipe/Machine）。
- 支持物料与配方的导入（JSON/CSV 至内存仓库），含完整校验与错误报告。
- 搭建最小仿真原型（单线：带→组装→出料），固定步进，能源域限额生效。
- 提供基础 API 与两页可视化（设计器 `/factory`、报表 `/reports`）。

现状与代码映射
- 域模型
  - `Item`：`src/libs/factory/Factory.Domain/Entities/Item.cs:3`
  - `Recipe`：`src/libs/factory/Factory.Domain/Entities/Recipe.cs:3-8`
  - `Machine`：`src/libs/factory/Factory.Domain/Entities/Machine.cs:5-9`
- 仿真引擎
  - 步进/能耗/库存/产出：`src/libs/factory/Factory.Simulation/Engine/SimulationEngine.cs:5-52`
  - 物流节点雏形（合流/分流）：`src/libs/factory/Factory.Simulation/Engine/TransportNetwork.cs:3-88`
- 数据仓库（内存）
  - 物料/配方：`src/libs/factory/Factory.Infrastructure/Repositories/InMemoryCatalogRepository.cs:11-30`
  - 蓝图：`src/libs/factory/Factory.Infrastructure/Repositories/InMemoryBlueprintRepository.cs:11-16`
- 应用端点与页面
  - API：`src/apps/Factory.Web/Program.cs:39-67`
  - 设计器：`src/apps/Factory.Web/Components/Pages/FactoryDesigner.razor:1-107`
  - 报表：`src/apps/Factory.Web/Components/Pages/FactoryReports.razor:1-35`

数据模型与校验规则（M1）
- Item
  - 字段：`id:string`、`name:string`、`category:string`、`stackSize:int(>0)`
  - 约束：`id` 唯一；`name/category` 非空；`stackSize >= 1`
- Recipe
  - 字段：`id:string`、`inputs:(itemId,amount:int>0)[]`、`outputs:(itemId,amount:int>0)[]`、`timeSeconds:double>0`、`powerKw:double>=0`
  - 约束：`id` 唯一；`inputs/outputs` 至少各一项；`itemId` 必须引用已存在的 `Item`；禁止相同 `itemId` 在同一侧重复；`timeSeconds>0`；`powerKw>=0`
- Machine（M1 可选，用于未来扩展）
  - 字段：`id:string`、`type:enum`、`speedMultiplier:double>0`、`powerUsageKw:double>=0`

导入规范
- 文件格式
  - JSON（推荐）
    ```json
    {
      "items": [
        { "id": "iron-ore", "name": "Iron Ore", "category": "raw", "stackSize": 100 },
        { "id": "iron-plate", "name": "Iron Plate", "category": "intermediate", "stackSize": 100 }
      ],
      "recipes": [
        {
          "id": "iron-plate-smelt",
          "inputs": [ { "itemId": "iron-ore", "amount": 1 } ],
          "outputs": [ { "itemId": "iron-plate", "amount": 1 } ],
          "timeSeconds": 1.0,
          "powerKw": 0.5
        }
      ]
    }
    ```
  - CSV（可选，分表）：`items.csv` 与 `recipes.csv`，字段同上，`inputs/outputs` 使用 `itemId:amount;itemId:amount` 形式。
- 校验流程（导入前置）
  - 逐项检查 `Item` 与 `Recipe` 字段合法性与引用闭包。
  - 收集错误列表并返回：`{ errors: [ { path, message } ] }`。
  - 通过后替换内存仓库（全量覆盖），失败则不变更。

API 契约（M1 最小集）
- GET `/api/items` → `Item[]`（已实现，`src/apps/Factory.Web/Program.cs:46`）
- GET `/api/recipes` → `Recipe[]`（已实现，`src/apps/Factory.Web/Program.cs:47`）
- GET `/api/sim/metrics` → `{ energyKWh, inventory, produced }`（已实现，`src/apps/Factory.Web/Program.cs:39-44`）
- POST `/api/blueprints`、GET `/api/blueprints/{id}`、POST `/api/factories/{id}/deploy`（已实现，蓝图最小闭环）
- POST `/api/catalog/import`（新增）
  - 请求（JSON/CSV 其中之一）：见“导入规范”。
  - 返回：`{ replaced: true, items: <count>, recipes: <count> }` 或 `400 { errors: [...] }`

仿真原型与能耗逻辑
- 步进公式（`SimulationEngine.Step`）
  - `totalPowerKw = Σ(recipe.powerKw)`；若 `totalPowerKw > PowerDomainKw`，按比例缩放 `seconds`。
  - `timeBatches = floor(effectiveSeconds / recipe.timeSeconds)`。
  - `batches = min(timeBatches, min_{i∈inputs}(floor(inventory[i.itemId]/i.amount)))`。
  - 更新库存与产出；能耗累加 `recipe.powerKw * (recipe.timeSeconds/3600) * batches`。
- 初始种子：通过 `Seed(itemId, amount)` 或页面按钮在设计器中注入原料。

产线概念（M1 范围）
- 定义：`Line` 代表一条围绕目标产物的工艺链路集合，包含若干设备与配方序列。
- 最小模型：
  - `Line`：`{ id, name, targetItemId, machines[] }`
  - `LineMetrics`：`{ throughput(items/s), energy(kWh), wip, inventoryDelta }`（按仿真步进累计）
- 动态扩容：
  - 允许在运行中向 `Line.machines[]` 添加/移除设备；下一步进生效。
  - 吞吐与能耗联动：新增设备提高批次能力，能耗按配方功率累计。
- 指标采集：
  - 在 `Step` 中按目标产物聚合 `Produced` 与能耗，生成行级指标；用于报表页面分组展示。

能耗阶段说明（M1）
- 电力设备：组装机等按 `recipe.powerKw` 消耗电力，汇总到 `TotalEnergyKWh`。
- 燃料设备：M1 不引入燃料消耗（煤炭等），统一视为电力近似；M2 将区分电力与燃料并对熔炉引入燃料模型。

验证实例（可直接复现）
- 场景：`iron-ore`→`iron-plate` 熔炼，能耗限制充足（`PowerDomainKw >= 0.5`）。
- 前置：
  - 导入上述 JSON 样例（或保持仓库默认数据）。
  - 在设计器页面 `/factory`，确保 `_engine.Inventory["iron-ore"] >= 10`（页面已在初始化时种下 10，`FactoryDesigner.razor:69-72`）。
- 步骤：
  1. 点击 `Start` 或执行一次 `Step`，将 `Step Seconds` 设为 `1.0`。
  2. 观察 `Inventory` 与 `Metrics` 面板：`iron-plate` 数量应随步进增加，`Energy` 按 `0.5 kW * 1s = 0.000139 kWh/批` 累加。
  3. 打开 `/reports`，`Produced["iron-plate"] / ElapsedSeconds ≈ 1.0`（稳态下吞吐≈1 件/秒）。
- 期望输出：
  - 每步 `1s`，在原料充足时，`iron-plate` 增量 `+1`；`iron-ore` 减量 `-1`。
  - 能耗累计与吞吐与时间线性相关，受 `PowerDomainKw` 限制时按比例降低。

错误与边界验证
- 原料不足：当 `_engine.Inventory["iron-ore"] < 1` 时，产出停止，能耗仅在完成批次时累加。
- 时间不足：`effectiveSeconds < recipe.timeSeconds` 不产生批次。
- 能源限额：设 `PowerDomainKw = 0.25` 时，`effectiveSeconds = seconds * 0.5`，吞吐减半。

测试方案（细化）
- 单元测试
  - 配方守恒：输入减少量=输出增加量（按配方系数）
  - 步进线性：`ElapsedSeconds` 与产出在非限电下近似线性。
  - 能耗一致性：能耗按批次与功率累加。
  - 校验器：非法 `itemId` 引用、负数/零 `amount`、`timeSeconds<=0`、`powerKw<0` 报错。
- 组件测试（bunit）
  - 设计器：`Start/Pause/Step` 状态与库存表渲染。
  - 报表：吞吐计算显示正确。
- 端到端（Playwright）
  - 流程：导入→种子→步进→校验吞吐与能耗→保存蓝图。
  - 断言：`/reports` 吞吐>0，`/api/sim/metrics` 字段齐全且数值随步进递增。

路由与页面对齐
- 现实现：`/factory`（设计器）、`/reports`（报表）。
- 文档推荐：`/factory/designer` 与 `/factory/reports`。后续统一路由以便 E2E。

实施清单（M1 完成要求）
- 新增导入端点 `POST /api/catalog/import`（读取 JSON/CSV、执行校验、替换内存仓库）。
- 增加服务层校验器（Domain/Infrastructure），在导入流程与启动时执行基本检查。
- 补充最小测试工程（单元/组件/E2E），按上述用例实现。
- 页面显示 `ElapsedSeconds` 与吞吐（设计器页已显示能耗，可复用报表计算）。

补充实施项（增强）
- 导入闭环与错误清单：JSON/CSV 导入返回标准错误结构（字段路径与原因），通过后全量替换目录。
- 仿真确定性与快照：提供固定种子选项、快照/恢复与单步重放，保证复现能力。
- 指标扩展：WIP、批次计数、分项能耗（按配方/设备）与时间窗聚合用于报表。
- 设计器约束：网格对齐、占位冲突提示、连线建议与库存容量/溢出规则。
- 蓝图增强：参数校验与默认化；保存后可回放验证实例。

验收标准（量化）
- 完成导入端点与校验，能处理 ≥100 条 `Item` 与 ≥200 条 `Recipe` 的 JSON。
- 单元测试覆盖率 ≥70%（配方守恒/能耗/限电缩放/校验错误）。
- 设计器与报表页面在 `http://localhost:5011/` 可访问，步进后吞吐>0。

补充验收
- 导入错误报告字段齐全且指向具体路径；通过后目录一致性（引用闭包、唯一性）满足。
- 快照/恢复后指标与库存一致；固定步长下吞吐与能耗线性、限电缩放比例正确。
- 设计器占位冲突能即时提示；蓝图保存后部署回放成功。

可验证页面与 API
- 设计器：`/factory`
- 报表：`/reports`
- API：`/api/items`、`/api/recipes`、`/api/sim/metrics`、`/api/blueprints`、`/api/factories/{id}/deploy`、（新增）`/api/catalog/import`

基础数据集（Factorio 简化示例）
- JSON（推荐，可直接用于导入端点）
  ```json
  {
    "items": [
      { "id": "iron-ore", "name": "Iron Ore", "category": "raw", "stackSize": 100 },
      { "id": "copper-ore", "name": "Copper Ore", "category": "raw", "stackSize": 100 },
      { "id": "stone", "name": "Stone", "category": "raw", "stackSize": 100 },
      { "id": "coal", "name": "Coal", "category": "raw", "stackSize": 100 },
      { "id": "iron-plate", "name": "Iron Plate", "category": "intermediate", "stackSize": 100 },
      { "id": "copper-plate", "name": "Copper Plate", "category": "intermediate", "stackSize": 100 },
      { "id": "stone-brick", "name": "Stone Brick", "category": "intermediate", "stackSize": 100 },
      { "id": "gear-wheel", "name": "Gear Wheel", "category": "intermediate", "stackSize": 100 },
      { "id": "copper-cable", "name": "Copper Cable", "category": "intermediate", "stackSize": 200 },
      { "id": "electronic-circuit", "name": "Electronic Circuit", "category": "intermediate", "stackSize": 200 }
    ],
    "recipes": [
      {
        "id": "iron-plate-smelt",
        "inputs": [ { "itemId": "iron-ore", "amount": 1 } ],
        "outputs": [ { "itemId": "iron-plate", "amount": 1 } ],
        "timeSeconds": 1.0,
        "powerKw": 0.5
      },
      {
        "id": "copper-plate-smelt",
        "inputs": [ { "itemId": "copper-ore", "amount": 1 } ],
        "outputs": [ { "itemId": "copper-plate", "amount": 1 } ],
        "timeSeconds": 1.0,
        "powerKw": 0.5
      },
      {
        "id": "stone-brick-smelt",
        "inputs": [ { "itemId": "stone", "amount": 2 } ],
        "outputs": [ { "itemId": "stone-brick", "amount": 1 } ],
        "timeSeconds": 1.0,
        "powerKw": 0.5
      },
      {
        "id": "gear-wheel-assemble",
        "inputs": [ { "itemId": "iron-plate", "amount": 2 } ],
        "outputs": [ { "itemId": "gear-wheel", "amount": 1 } ],
        "timeSeconds": 0.5,
        "powerKw": 0.2
      },
      {
        "id": "copper-cable-assemble",
        "inputs": [ { "itemId": "copper-plate", "amount": 1 } ],
        "outputs": [ { "itemId": "copper-cable", "amount": 2 } ],
        "timeSeconds": 0.5,
        "powerKw": 0.2
      },
      {
        "id": "electronic-circuit-assemble",
        "inputs": [ { "itemId": "iron-plate", "amount": 1 }, { "itemId": "copper-cable", "amount": 3 } ],
        "outputs": [ { "itemId": "electronic-circuit", "amount": 1 } ],
        "timeSeconds": 0.5,
        "powerKw": 0.3
      }
    ]
  }
  ```
- CSV（可选方案，分表）
  - `items.csv`
    ```csv
    id,name,category,stackSize
    iron-ore,Iron Ore,raw,100
    copper-ore,Copper Ore,raw,100
    stone,Stone,raw,100
    coal,Coal,raw,100
    iron-plate,Iron Plate,intermediate,100
    copper-plate,Copper Plate,intermediate,100
    stone-brick,Stone Brick,intermediate,100
    gear-wheel,Gear Wheel,intermediate,100
    copper-cable,Copper Cable,intermediate,200
    electronic-circuit,Electronic Circuit,intermediate,200
    ```
  - `recipes.csv`
    ```csv
    id,timeSeconds,powerKw,inputs,outputs
    iron-plate-smelt,1.0,0.5,"iron-ore:1","iron-plate:1"
    copper-plate-smelt,1.0,0.5,"copper-ore:1","copper-plate:1"
    stone-brick-smelt,1.0,0.5,"stone:2","stone-brick:1"
    gear-wheel-assemble,0.5,0.2,"iron-plate:2","gear-wheel:1"
    copper-cable-assemble,0.5,0.2,"copper-plate:1","copper-cable:2"
    electronic-circuit-assemble,0.5,0.3,"iron-plate:1;copper-cable:3","electronic-circuit:1"
    ```

扩展验证建议（使用基础数据集）
- 种子原料：在 `/factory` 页面初始化或通过 `Seed` 方法注入 `iron-ore` 与 `copper-ore`。
- 步进：选择 `1.0s` 步长执行 `Start/Step`，在 `/reports` 观察 iron/copper plate 吞吐为正。
- 能源限额：降低 `PowerDomainKw` 以观察吞吐缩放，与文档公式一致。
- 多配方链路：在导入数据生效后，逐步观察 `gear-wheel`、`copper-cable`、`electronic-circuit` 的产出随上游原料与时间推进递增。

迭代任务清单（M1）
- 目录导入闭环（JSON/CSV 校验与错误结构、引用闭包验证、全量替换）。
- 仿真确定性与快照（固定步长/种子、快照/恢复、单步重放）。
- 指标扩展与报表口径（WIP/批次计数/分项能耗、时间窗聚合）。
- 设计器约束与提示（网格对齐、占位冲突、连线建议、容量/溢出规则）。
- 蓝图参数校验与默认化、保存后回放验证。

验收用例列表（M1）
- 导入≥100 `Item` 与≥200 `Recipe` 成功；错误清单包含具体字段路径与原因。
- 在原料充足与 `Step(1.0s)` 下，`iron-plate` 吞吐≈`1/s`；降低 `PowerDomainKw` 时吞吐按比例缩放。
- 快照→恢复后 `Inventory/Produced/TotalEnergyKWh` 与 `ElapsedSeconds` 一致；单步重放结果与前次一致。
- 设计器占位冲突即时提示；蓝图保存→部署→回放验证通过。
