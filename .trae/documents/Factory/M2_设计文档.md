M2 设计文档 — 物流网络与能源系统、蓝图参数化

范围与目标
- 物流网络增强：合流/分流/优先级策略、反压传播与拥塞定位。
- 能耗系统：供电域覆盖、负载曲线、超限降频策略。
- 蓝图：保存与参数化部署（带速、模块数、设备等级）。

新增范围（细化）
- 能源类型区分：电力设备与燃料设备分离建模（熔炉消耗燃料，装配机消耗电）。
- 产线度量：按产线聚合吞吐/能耗/占地与饥饿时间，支持对比与优化。
- 设备占位与带运力：网格占位与传送带/机械臂的速率/容量模型，避免运力不足导致下游饥饿。

服务与职责
- 应用/API（`Factory.Web`）
  - `LogisticsController`：带/臂/管网络查询与策略调整。
  - `PowerController`：供电域与负载查询、限电策略配置。
  - `BlueprintsController`：蓝图参数化与版本管理。
  - `LinesController`：产线列表与行级指标查询、设备增删。
- 领域服务（`Factory.Domain`）
  - `LogisticsService`：网络拓扑建模、速率/容量/延迟计算与优先级策略。
  - `PowerService`：设备功耗曲线、供电范围与负载分配。
  - `BlueprintService`：参数模板与镜像/旋转布局支持。
  - `LineService`：产线维护与行级度量聚合。
- 仿真引擎（`Factory.Simulation`）
  - `NetworkFlow`：带/臂/管速率、队列容量与延迟；拥塞反压传播模型。
  - `PowerDomain`：电网覆盖、功率预算与动态降频。
  - `OptimizerHooks`：可插拔调度器接口（优先级策略）。
  - `EnergyModel`：设备能耗类型与燃料消耗（熔炉燃煤）与电力域集成。
  - `StarvationDetector`：按设备/产线记录无料可用的饥饿时长与次数。
- 基础设施（`Factory.Infrastructure`）
  - `TopologyStore`：网络拓扑持久化与查询。
  - `BlueprintStore`：蓝图版本化与参数模板存储。
  - `LineStore`：产线定义与指标快照持久化。
- UI 组件（`Factory.Components`）
  - `FlowHeatmap`：物流热力图（速率/拥塞可视化）。
  - `PowerOverlay`：电力覆盖与负载可视化。
  - `LineDashboard`：产线吞吐/能耗/饥饿时间图与设备清单。

接口设计（示例）
- GET `/api/logistics/{factoryId}/network`
- POST `/api/logistics/{factoryId}/priority`
- GET `/api/power/{factoryId}/domain`
- POST `/api/power/{factoryId}/throttle`
- POST `/api/blueprints/{id}/deploy?params=...`
 - GET `/api/lines?factoryId=...` → `Line[]`
 - GET `/api/lines/{id}/metrics` → `LineMetrics`
 - POST `/api/lines/{id}/machines`（增删设备）

测试方案
- 单元测试
  - 合流/分流：速率守恒与优先级正确性。
  - 反压传播：拥塞在下游对上游速率影响的延迟与幅度。
  - 电网负载：超过功率预算时的降频策略正确执行。
  - 燃料消耗：熔炉在燃料不足时停机，燃料充足时能耗不计入电力域。
  - 设备占位：禁止占位重叠与越界；占位更新后拓扑重建。
  - 饥饿检测：在输入带运力低于需求时，设备记录饥饿时长累计。
- 组件测试（bunit）
  - 热力图颜色映射与图例正确显示。
  - 电网覆盖图层正确切换。
  - 产线仪表盘展示吞吐/能耗与设备列表，支持动态增删设备。
- 端到端（Playwright）
  - 流程：设计多线物流→观察拥塞→调整优先级→能耗页面验证。
  - 断言：拥塞点定位稳定、优先级调整后吞吐改善；燃料不足时熔炉停机且产线吞吐下降。
- 属性测试
  - 网络流量守恒与非负性、优先级策略的单调性。
  - 产线吞吐与能耗随设备数量单调不减（限电或燃料约束下进行边界验证）。
- 基准测试
  - 多拓扑规模与不同带速下的仿真性能与内存占用。

验收标准
- 物流热力图与拥塞定位有效。
- 能耗/供电域可视化正确，限电策略生效。
- 蓝图参数化部署在典型场景下可用。
 - 熔炉燃料消耗与电力消耗并行建模正确；无燃料时正确停机。
 - 产线指标可查询，含吞吐、能耗、饥饿时长、占位面积。

可验证页面
- `/factory/logistics`
- `/factory/power`
- `/factory/blueprints`
 - `/factory/lines`
