M4 设计文档 — 列车与跨区物流、地形与污染、蓝图分享

范围与目标
- 高级物流：列车与跨区运输，站点调度与路径规划。
- 地图地形：资源分布、障碍与污染模型引入。
- 蓝图市场：蓝图分享、版本与评分（可选）。

数据模型（细化）
- RailStation：`{ id, name, position, buffers{itemId→capacity}, schedule[{ trainId, arrival, departure }] }`
- Train：`{ id, capacity{itemId→amount}, speed, route[stationId], status:"idle|enroute|loading|unloading" }`
- RailRoute：`{ id, stations[], distance, travelTime }`
- MapTile：`{ row, col, type:"plain|water|forest|rock", resource{itemId→richness}, pollution:double, walkable:boolean }`
- BlueprintShare：`{ id, name, version, author, json, params, tags[], rating, downloads }`

接口契约（含示例）
- POST `/api/train/routes`
  - 请求：`{ stations:[stationId], objective:"shortest|fastest|fuel_efficient", constraints:{ avoidTypes:["water"], maxSlope? } }`
  - 返回：`RailRoute`
- GET `/api/train/schedule` → `{ trains[], stations[] }`
- GET `/api/map/tiles?bbox=...&layers=resource,pollution` → `MapTile[]`
- POST `/api/market/blueprints`
  - 请求：`{ name, json, params, tags }`
  - 返回：`{ id, version }`
- GET `/api/market/blueprints?id=...` → `BlueprintShare`

算法与策略（实现指引）
- 路径规划
  - Dijkstra/A*：权重可组合（距离/时间/能耗/风险），支持障碍与地形成本。
  - 调度与冲突避免：站点容量与时间窗冲突检测；必要时插入等待或调整车次。
- 装卸规则
  - 站点缓冲区容量与优先级策略；上/下游反压传递到带/臂网络。
- 地形与污染
  - 资源丰富度影响采集速率；污染沿邻接扩散，影响能耗或设备效率（可选）。
  - 水/障碍不可通行，森林/岩石可清理有成本。
- 蓝图分享
  - 版本治理与参数模板；评分与下载统计，支持 JSON 校验与安全审查。

UI 与交互（页面）
- `RailPlanner`（`/factory/rail`）：站点编辑、线路规划、时刻表视图；冲突高亮与修复建议。
- `MapOverlay`（`/factory/map`）：地图图层选择（资源/污染/障碍），框选与明细面板。
- `Marketplace`（`/factory/market`）：蓝图上传/浏览/评分；版本与参数化展示。

测试方案（细化）
- 单元测试
  - 路径规划最短/快速路径正确；地形与约束生效。
  - 调度冲突检测与解决策略稳定；站点容量约束正确。
  - 分享蓝图的版本化与参数校验正确，评分与统计更新。
- 组件测试（bunit）
  - 线路编辑与时刻表渲染；冲突标识与提示。
  - 地图图层叠加与选择；框选细节展示。
- 端到端（Playwright）
  - 流程：构建跨区物流→列车运行→资源收发→蓝图分享与下载→参数化部署。
  - 断言：车次按时刻表运行无冲突，地图图层显示一致，分享的蓝图可复用。
- 基准测试
  - 大地图、多车次场景下路径计算与调度性能；内存占用与刷新稳定性。

验收标准（量化）
- 线路规划在中等规模下 `< 1s` 返回；调度冲突可被定位与解决。
- 地图图层渲染稳定；污染与资源分布正确。
- 蓝图分享可用且安全，支持版本与评分。

可验证页面
- `/factory/rail`
- `/factory/map`
- `/factory/market`

实施清单（M4 完成要求）
- 列车系统：站点/线路/时刻表模型；路径规划（Dijkstra/A*）与冲突检测；区块/信号与等待策略。
- 站点缓冲与装卸：容量与优先级策略；与带/臂网络的衔接与反压传递。
- 地图地形与污染：图层渲染（资源/污染/障碍）、通行约束与清理成本；污染扩散与能耗/效率耦合。
- 蓝图分享与市场：上传/浏览/评分与版本治理；JSON Schema 校验与来源签名（可选）。
- 页面：`/factory/rail`、`/factory/map`、`/factory/market` 视图与交互。

补充验收
- 路径规划在中等规模 `< 1s` 返回；时刻表冲突能定位与解决（等待或调整）。
- 地图图层叠加稳定；资源分布与污染可视化与仿真一致；障碍通行约束生效。
- 蓝图分享条目版本化与评分更新正确；不合规 JSON 被拒绝且给出错误详情。

验收用例列表（M4）
- 规划包含 4 站点的线路，计算路径 `<1s`；引入冲突后系统提示并建议等待或调整时刻表。
- 地图切换资源/污染/障碍图层：渲染正确；设置不可通行区后路径规避生效。
- 上传不合规蓝图（JSON 缺字段）：被拒并返回错误清单；上传合规蓝图后版本与评分可更新。

现状与代码映射（M4）
- 列车/地图/市场相关服务与端点：暂无（待实现）。
- 现有可复用基础：仿真步进与物流节点（合流/分流）→ `src/libs/factory/Factory.Simulation/Engine/SimulationEngine.cs:25-52`、`src/libs/factory/Factory.Simulation/Engine/TransportNetwork.cs:1-88`

商品市场与经济系统（新增）

范围与目标
- 定期发布可出售/采购的物资订单；完成交易影响预算与库存。
- 资金用于采购更好的设备（产能/良率提升）与土地（资源地/空地）。

数据模型
- MarketOrder：`{ id, type:"buy|sell", itemId, qty, price, expiresAt }`
- Budget：`{ balance, income, expenses, assets{ machinesValue, landValue } }`

接口契约
- GET `/api/market/orders` → `MarketOrder[]`
- POST `/api/market/trade` → 提交交易，更新库存与预算
- GET `/api/economy/budget` → `Budget`
- POST `/api/economy/purchase/machine` → 购买/升级设备（影响 `speed/quality/power`）
- POST `/api/economy/purchase/land` → 购买土地（资源地/空地），更新地图与可建设区域

UI 与交互
- `Marketplace` 页面新增页签“商品市场”：显示买/卖订单列表与预算卡片；下单与成交反馈。
- `Economy` 页面（可选）：预算与资产视图，设备/土地采购入口；展示采购对仿真指标的影响。

验收标准
- 成交后库存与预算同步更新；价格/数量正确结算。
- 设备/土地采购对引擎与地图生效（产能/良率/可建设区域变化）。

服务与职责
- 应用/API（`Factory.Web`）
  - `TrainController`：线路与车次管理、站点时刻表。
  - `MapController`：地形/资源/污染查询与编辑（管理员权限）。
  - `MarketplaceController`：蓝图上传/浏览/评分。
- 领域服务（`Factory.Domain`）
  - `TrainService`：路径规划（Dijkstra/A*）、站点调度与装卸规则。
  - `MapService`：网格地形与资源生成、障碍与污染传播。
  - `BlueprintService`：分享元数据与版本治理。
- 仿真引擎（`Factory.Simulation`）
  - `RailNetwork`：站点/线路/车次仿真与冲突避免。
  - `TerrainModel`：地形对物流与能耗的影响。
- 基础设施（`Factory.Infrastructure`）
  - `MapStore`：地图与资源数据持久化。
  - `MarketplaceStore`：蓝图市场条目与评价。
- UI 组件（`Factory.Components`）
  - `RailPlanner`：车站/线路编辑器与时刻表视图。
  - `MapOverlay`：地形/资源/污染图层。

接口设计（示例）
- POST `/api/train/routes`
- GET `/api/train/schedule`
- GET `/api/map/tiles?bbox=...`
- POST `/api/market/blueprints`

测试方案
- 单元测试
  - 路径规划最短路径与资源约束正确性。
  - 车次冲突检测与调度稳定性。
  - 污染传播模型的守恒与衰减规律。
- 组件测试（bunit）
  - 线路编辑交互与时刻表渲染。
  - 地图图层叠加与选择。
- 端到端（Playwright）
  - 流程：构建跨区物流→列车运行→资源收发→蓝图分享。
- 基准测试
  - 大地图与多车次场景下的性能与内存占用。

验收标准
- 列车与跨区物流稳定运行，冲突避免有效。
- 地形/资源/污染渲染与仿真一致。

可验证页面
- `/factory/rail`
- `/factory/map`
- `/factory/market`
