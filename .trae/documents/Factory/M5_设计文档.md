M5 设计文档 — 性能与稳定性、数据导出与扩展接口

范围与目标
- 性能与稳定性专项：大规模场景的 TPS、内存与延迟优化。
- 数据导出与报告完善：CSV/Excel 与可视化增强。
- 脚本化与扩展接口：策略与设备/配方注册扩展点。

指标与基线（细化）
- 性能指标：`TPS`、`StepLatency(ms)`、`CPU%`、`Memory(MB)`、`GC暂停(ms)`、`DroppedTicks`
- 稳定性指标：`SteadyStateTime(s)`、`RecoveryTime(s)`、`ErrorRate`（在注入故障下）
- 基线场景：`N=1k/10k/100k` 节点拓扑、不同带速/设备等级与能耗域组合

接口契约（含示例）
- GET `/api/diagnostics/metrics` → `{ tps, latencyMs, cpu, memoryMb, gcPauseMs, droppedTicks }`
- POST `/api/diagnostics/chaos`
  - 请求：`{ mode:"drop|throttle|delay|fuel_outage", target:"edge|machine|line|global", rate|limit|latencyMs, durationMs }`
  - 返回：`{ started:true, id }`
- GET `/api/reports/export?type=excel&range=...` → 文件下载（Excel/CSV）
- POST `/api/extensions/register`
  - 请求：`{ type:"strategy|machine|recipe", name, version, payload }`
  - 返回：`{ id, status:"registered|rejected" }`

导出与报告（细化）
- 报表管道：支持 `throughput/energy/inventory/wip/cost` 维度；字段映射与单位明确定义
- CSV/Excel 模板：列头与示例行；时间戳与窗口聚合（avg/min/max）
- 数据血缘：来源于引擎快照与聚合函数；导出含元数据（版本/采样频率/窗口大小）

扩展接口与安全
- 注册表：`ExtensionRegistry` 管理外部策略/设备/配方；版本与依赖校验
- 沙箱：策略执行隔离与时间/内存配额；异常捕获与熔断
- 安全审查：蓝图与扩展载荷的 JSON Schema 校验；签名与来源验证（可选）

仿真引擎优化建议
- 分层调度：计算型热点拆分、带/臂网络流量计算批处理
- 数据结构：环形缓冲、池化与 Span/Memory 优化，减少 GC 压力
- 并行化：独立线/区并发推进，结果在同步点归并；避免锁竞争
- 采样与节流：诊断采样与 UI 刷新节流，降低观测开销

测试方案（细化）
- 单元测试：指标采集与聚合正确；导出字段映射与格式校验；扩展注册生命周期事件
- 端到端：大规模仿真→注入故障→观察稳态→导出报告→注册扩展并运行
- 属性测试：稳态识别与恢复阈值不变式；扩展策略不破坏守恒与非负性
- 压测与基准：不同规模与参数下的 `TPS/Memory/Latency` 曲线；回归基线对比

验收标准（量化）
- `N=10k` 节点场景下 `TPS ≥ 30`、`StepLatency P95 ≤ 50ms`、`Memory ≤ 2GB`
- 故障注入下 `RecoveryTime ≤ 10s`、`ErrorRate ≤ 1%`
- 报表导出字段齐全、格式正确、含元数据；扩展接口安全可用

可验证页面
- `/factory/diagnostics`
- `/factory/reports/export`

服务与职责
- 应用/API（`Factory.Web`）
  - `DiagnosticsController`：性能指标采集与故障注入控制（测试环境）。
  - `ExportController`：报表与数据导出。
  - `ExtensionsController`：策略/设备/配方注册管理。
- 领域服务（`Factory.Domain`）
  - `DiagnosticsService`：采样/追踪与指标聚合。
  - `ExportService`：报表管道与格式化。
  - `ExtensionsService`：扩展点注册与生命周期管理。
- 仿真引擎（`Factory.Simulation`）
  - `Profiler`：Tick 内热点与耗时分布。
  - `ChaosHooks`：故障注入（丢包/限电/延迟）与稳态恢复能力测试。
- 基础设施（`Factory.Infrastructure`）
  - `ExportPipeline`：CSV/Excel 输出与存储集成。
  - `ExtensionRegistry`：外部策略/设备/配方注册表。
- UI 组件（`Factory.Components`）
  - `DiagnosticsDashboard`：性能与稳定性指标可视化。

接口设计（示例）
- GET `/api/diagnostics/metrics`
- POST `/api/diagnostics/chaos`
- GET `/api/reports/export?type=excel`
- POST `/api/extensions/register`

测试方案
- 单元测试
  - 指标采集与聚合正确性。
  - 导出格式与字段映射校验。
  - 扩展点注册与生命周期事件。
- 端到端（Playwright）
  - 流程：大规模仿真→注入故障→观察稳态→导出报告。
- 属性测试
  - 稳态识别与恢复阈值不变式。
- 基准与压测
  - 规模阶跃（N=1k/10k/100k 节点）下 TPS/内存曲线。

验收标准
- 性能指标达标，稳定性测试通过。
- 导出功能完整且可复核。
- 扩展接口可用且安全。

可验证页面
- `/factory/diagnostics`
- `/factory/reports/export`
